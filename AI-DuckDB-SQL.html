<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI SQL — Browser Query Tool</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cousine:wght@400;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <style type="text/tailwindcss">
    @theme {
      --color-base-3: #fdf6e3;
      --color-base-2: #eee8d5;
      --color-base-1: #93a1a1;
      --color-base-00: #657b83;
      --color-base-01: #586e75;

      --color-sol-cyan: #2aa198;
      --color-sol-green: #859900;
      --color-sol-yellow: #b58900;
      --color-sol-orange: #cb4b16;
      --color-sol-red: #dc322f;
      --color-sol-magenta: #d33682;

      --font-mono: 'Cousine', 'Monaco', 'Consolas', monospace;
    }

    @keyframes fade-in-down {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fade-in-up {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(42, 161, 152, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(42, 161, 152, 0); }
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>

  <style>
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--color-base-2); }
    ::-webkit-scrollbar-thumb { background: var(--color-base-1); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--color-sol-cyan); }

    .results-table { border-collapse: collapse; width: 100%; }
    .results-table th {
      background: var(--color-base-2);
      color: var(--color-base-01);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 8px 12px;
      text-align: left;
      border-bottom: 2px solid rgba(147, 161, 161, 0.3);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .results-table td {
      padding: 6px 12px;
      border-bottom: 1px solid rgba(147, 161, 161, 0.12);
      font-size: 13px;
      color: var(--color-base-00);
      max-width: 350px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .results-table tr:hover td {
      background: rgba(42, 161, 152, 0.05);
    }
    .results-table td.null-val {
      color: var(--color-base-1);
      font-style: italic;
    }

    .sql-editor {
      resize: vertical;
      min-height: 140px;
      tab-size: 2;
    }
    .sql-editor:focus {
      outline: none;
      border-color: var(--color-sol-cyan);
      box-shadow: 0 0 0 3px rgba(42, 161, 152, 0.2);
    }

    .loading-overlay {
      background: rgba(253, 246, 227, 0.97);
      backdrop-filter: blur(4px);
    }

    .example-btn {
      display: block;
      width: 100%;
      text-align: left;
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 4px;
      cursor: pointer;
      border: 1px solid transparent;
      background: transparent;
      color: var(--color-base-00);
      font-family: var(--font-mono);
      transition: all 0.15s ease;
    }
    .example-btn:hover {
      background: var(--color-base-3);
      border-color: rgba(147, 161, 161, 0.2);
      color: var(--color-sol-cyan);
    }

    .running-shimmer {
      background: linear-gradient(90deg, var(--color-base-2) 0%, rgba(42, 161, 152, 0.12) 50%, var(--color-base-2) 100%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
    }

    #llm-thinking-chevron.expanded {
      transform: rotate(90deg);
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>

<body class="font-mono bg-base-3 text-base-00 min-h-screen">
  <!-- Fixed background gradient -->
  <div class="fixed inset-0 -z-10"
       style="background:
         linear-gradient(135deg, #fdf6e3 0%, #eee8d5 100%),
         radial-gradient(circle at 20% 80%, rgba(42,161,152,0.08) 0%, transparent 50%),
         radial-gradient(circle at 80% 20%, rgba(42,161,152,0.05) 0%, transparent 50%);">
  </div>

  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay fixed inset-0 z-50 flex flex-col items-center justify-center">
    <div class="text-center">
      <div class="text-4xl mb-4 animate-[pulse-glow_2s_infinite]"
           style="display: inline-block; padding: 16px; border-radius: 12px;">
        &#x1F986;
      </div>
      <p class="text-base-01 text-sm mt-4" id="loading-message">Initializing DuckDB...</p>
    </div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-40 px-6 lg:px-12 py-4 border-b border-base-1/20 bg-base-3/90 backdrop-blur-sm
                 animate-[fade-in-down_0.4s_cubic-bezier(0.4,0,0.2,1)_backwards]">
    <nav class="flex justify-between items-center max-w-[1400px] mx-auto">
      <div class="flex items-center gap-3">
        <span class="text-lg font-bold text-sol-cyan tracking-tight">DuckDB SQL</span>
        <span class="text-xs text-base-1 border border-base-1/30 rounded px-2 py-0.5">WASM</span>
      </div>
      <div class="flex items-center gap-4">
        <div id="status-indicator" class="flex items-center gap-2 text-xs text-base-1">
          <span id="status-dot" class="w-2 h-2 rounded-full bg-sol-yellow"></span>
          <span id="status-text">Loading...</span>
        </div>
      </div>
    </nav>
  </header>

  <!-- Main content -->
  <main class="max-w-[1400px] mx-auto px-6 lg:px-12 py-8
               animate-[fade-in-up_0.6s_cubic-bezier(0.4,0,0.2,1)_backwards]">
    <div class="grid grid-cols-1 lg:grid-cols-[1fr_320px] gap-8">

      <!-- Left: Editor + Results -->
      <div class="space-y-6 min-w-0">

        <!-- Natural Language Input Card -->
        <div class="bg-base-2 border border-base-1/20 rounded shadow-[0_2px_8px_rgba(101,123,131,0.08)]">
          <div class="flex items-center justify-between px-4 py-2.5 border-b border-base-1/15">
            <div class="flex gap-1">
              <button id="llm-tab-question" class="px-3 py-1 text-xs font-semibold rounded
                             bg-base-3 text-base-00 border border-base-1/20
                             transition-all duration-150 cursor-pointer">
                Question
              </button>
              <button id="llm-tab-prompt" class="px-3 py-1 text-xs font-semibold rounded
                             bg-transparent text-base-1 border border-transparent
                             transition-all duration-150 cursor-pointer
                             hover:text-base-00">
                Prompt
              </button>
            </div>
            <span class="text-[11px] text-base-1 hidden sm:inline">Ctrl+Enter to generate</span>
          </div>

          <!-- Question Tab Content -->
          <div id="llm-tab-content-question">
            <textarea id="nl-input"
                      class="sql-editor w-full px-4 py-3 bg-base-3 text-[13px] text-base-00 font-mono leading-relaxed tracking-tight border-0 border-b border-base-1/15"
                      rows="3"
                      spellcheck="false"
                      placeholder="Describe what you want to query, e.g. &quot;Show me the top 10 companies by revenue&quot;"></textarea>
          </div>

          <!-- Prompt Tab Content -->
          <div id="llm-tab-content-prompt" class="hidden">
            <div class="flex justify-between items-center px-4 pt-2">
              <p class="text-[11px] text-base-1">Edit the prompt template. Use <code class="text-sol-cyan">{question}</code> and <code class="text-sol-cyan">{schema}</code> as placeholders.</p>
              <button id="llm-reset-prompt-btn" class="text-[11px] text-sol-cyan hover:underline cursor-pointer bg-transparent border-0 font-mono p-0">Reset to Default</button>
            </div>
            <textarea id="llm-prompt-input"
                      class="sql-editor w-full px-4 py-3 bg-base-3 text-[13px] text-base-00 font-mono leading-relaxed tracking-tight border-0 border-b border-base-1/15"
                      rows="10"
                      spellcheck="false"></textarea>
          </div>
          <div class="flex items-center justify-between px-4 py-2.5">
            <!-- Model Status (left) -->
            <div id="llm-status-section" class="text-[11px] text-base-01 flex items-center gap-2 flex-wrap">
              <label class="inline-flex items-center gap-1.5 cursor-pointer select-none
                            has-[:disabled]:opacity-50 has-[:disabled]:cursor-not-allowed">
                <input type="checkbox" id="llm-webgpu-toggle" checked
                       class="w-3.5 h-3.5 accent-sol-cyan cursor-pointer disabled:cursor-not-allowed">
                <span>WebGPU</span>
              </label>
              <span id="llm-loading-message" class="text-base-1">Checking WebGPU...</span>
              <span id="llm-progress-container"></span>
            </div>
            <!-- Buttons (right) -->
            <div class="flex gap-2">
              <button id="llm-stop-btn"
                      class="hidden bg-sol-orange text-base-3 px-4 py-1.5 text-xs font-semibold rounded cursor-pointer
                             transition-all duration-150
                             hover:shadow-[0_4px_12px_rgba(203,75,22,0.3)]">
                Stop
              </button>
              <button id="llm-generate-btn"
                      disabled
                      class="bg-sol-cyan text-base-3 px-5 py-1.5 text-xs font-semibold rounded cursor-pointer
                             transition-all duration-150
                             hover:shadow-[0_4px_12px_rgba(42,161,152,0.3)] hover:-translate-y-0.5
                             active:scale-[0.98]
                             disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none">
                &#9889; Generate SQL
              </button>
            </div>
          </div>
        </div>

        <!-- LLM Error display -->
        <div id="llm-error-container" class="hidden">
          <div class="bg-base-2 border border-sol-red/30 border-l-[3px] border-l-sol-red rounded p-4">
            <div class="flex items-start gap-3">
              <span class="text-sol-red text-sm mt-0.5 shrink-0">&#x2717;</span>
              <div class="min-w-0">
                <p class="text-xs text-sol-red font-semibold uppercase tracking-wider mb-1">LLM Error</p>
                <pre id="llm-error-message" class="text-[13px] text-base-00 whitespace-pre-wrap leading-relaxed break-words font-mono"></pre>
              </div>
            </div>
          </div>
        </div>

        <!-- Thinking Section (collapsible) -->
        <div id="llm-thinking-section" class="hidden">
          <div class="bg-base-2 border border-base-1/20 rounded p-4 shadow-[0_2px_8px_rgba(101,123,131,0.08)]">
            <button id="llm-thinking-toggle" class="w-full flex justify-between items-center text-left cursor-pointer bg-transparent border-0 font-mono p-0">
              <div class="flex items-center gap-2">
                <span id="llm-thinking-chevron" class="text-base-1 transition-transform duration-200 text-[10px]">&#9654;</span>
                <span class="text-xs font-semibold uppercase tracking-wider">Thinking</span>
                <span id="llm-thinking-status" class="text-[11px] text-base-1">(reasoning...)</span>
              </div>
            </button>
            <div id="llm-thinking-content" class="mt-3">
              <pre id="llm-thinking-output" class="text-[12px] text-base-01 whitespace-pre-wrap max-h-48 overflow-y-auto"></pre>
            </div>
          </div>
        </div>

        <!-- Streaming Preview (shown during generation) -->
        <div id="llm-streaming-section" class="hidden">
          <div class="bg-base-2 border border-base-1/20 border-l-[3px] border-l-sol-cyan rounded p-4">
            <div class="flex justify-between items-center mb-2">
              <span id="llm-streaming-label" class="text-xs font-semibold uppercase tracking-wider">Generating SQL</span>
              <span id="llm-throbber" class="inline-block w-3 h-3 border-2 border-sol-cyan/30 border-t-sol-cyan rounded-full animate-spin"></span>
              <span id="llm-tps-display" class="text-[11px] text-base-1">-- tokens/sec</span>
            </div>
            <pre id="llm-streaming-output" class="text-[13px] text-base-00 whitespace-pre-wrap max-h-48 overflow-y-auto font-mono"></pre>
          </div>
        </div>

        <!-- SQL Editor Card -->
        <div class="bg-base-2 border border-base-1/20 rounded shadow-[0_2px_8px_rgba(101,123,131,0.08)]">
          <div class="flex items-center justify-between px-4 py-2.5 border-b border-base-1/15">
            <label class="text-xs text-base-1 uppercase tracking-wider">SQL Query</label>
            <span class="text-[11px] text-base-1 hidden sm:inline">Ctrl+Enter to run</span>
          </div>
          <textarea id="sql-editor"
                    class="sql-editor w-full px-4 py-3 bg-base-3 text-[13px] text-base-00 font-mono leading-relaxed tracking-tight border-0 border-b border-base-1/15"
                    rows="10"
                    spellcheck="false"
                    placeholder="Enter SQL query...">SELECT 42 AS answer, 'Hello DuckDB!' AS greeting;</textarea>
          <div class="flex items-center justify-between px-4 py-2.5">
            <div id="query-info" class="text-[11px] text-base-1"></div>
            <div class="flex gap-2">
              <button id="clear-btn"
                      class="bg-transparent text-base-00 border border-base-1/30 px-4 py-1.5 text-xs font-semibold rounded cursor-pointer
                             transition-all duration-150
                             hover:bg-base-3 hover:border-base-1/50">
                Clear
              </button>
              <button id="run-btn"
                      class="bg-sol-cyan text-base-3 px-5 py-1.5 text-xs font-semibold rounded cursor-pointer
                             transition-all duration-150
                             hover:shadow-[0_4px_12px_rgba(42,161,152,0.3)] hover:-translate-y-0.5
                             active:scale-[0.98]
                             disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none">
                &#9654; Run Query
              </button>
            </div>
          </div>
        </div>

        <!-- Running indicator -->
        <div id="running-bar" class="hidden h-1 rounded running-shimmer"></div>

        <!-- Results Table -->
        <div id="results-container" class="hidden">
          <div class="bg-base-2 border border-base-1/20 rounded shadow-[0_2px_8px_rgba(101,123,131,0.08)] overflow-hidden">
            <div class="flex items-center justify-between px-4 py-2.5 border-b border-base-1/15">
              <label class="text-xs text-base-1 uppercase tracking-wider">Results</label>
              <span id="result-stats" class="text-[11px] text-base-1"></span>
            </div>
            <div id="results-scroll" class="overflow-auto max-h-[500px] bg-base-3">
              <table class="results-table" id="results-table">
                <thead id="results-thead"></thead>
                <tbody id="results-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Error display -->
        <div id="error-container" class="hidden">
          <div class="bg-base-2 border border-sol-red/30 border-l-[3px] border-l-sol-red rounded p-4">
            <div class="flex items-start gap-3">
              <span class="text-sol-red text-sm mt-0.5 shrink-0">&#x2717;</span>
              <div class="min-w-0">
                <p class="text-xs text-sol-red font-semibold uppercase tracking-wider mb-1">Query Error</p>
                <pre id="error-message" class="text-[13px] text-base-00 whitespace-pre-wrap leading-relaxed break-words font-mono"></pre>
              </div>
            </div>
          </div>
        </div>

        <!-- Success message (DDL / DML) -->
        <div id="success-container" class="hidden">
          <div class="bg-base-2 border border-sol-green/30 border-l-[3px] border-l-sol-green rounded p-4">
            <div class="flex items-start gap-3">
              <span class="text-sol-green text-sm mt-0.5 shrink-0">&#x2713;</span>
              <p id="success-message" class="text-[13px] text-base-00"></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Examples & Info Sidebar -->
      <aside class="space-y-4">
        <div class="sticky top-[72px] space-y-4 max-h-[calc(100vh-90px)] overflow-y-auto pr-1">

          <!-- Example Queries -->
          <div class="bg-base-2 border border-base-1/20 border-l-[3px] border-l-sol-cyan rounded p-5">
            <h4 class="text-sm font-semibold mb-3">Example Queries</h4>
            <div class="space-y-1" id="examples-list"></div>
          </div>

          <!-- Tips -->
          <div class="bg-base-2 border border-base-1/20 rounded p-5">
            <h4 class="text-sm font-semibold mb-3">Tips</h4>
            <ul class="space-y-2 text-[12px] text-base-01 leading-relaxed">
              <li><strong class="text-base-00">Ctrl+Enter</strong> runs the query</li>
              <li><strong class="text-base-00">Tab</strong> inserts two spaces</li>
              <li>Query remote <strong class="text-base-00">Parquet</strong>, <strong class="text-base-00">CSV</strong>, and <strong class="text-base-00">JSON</strong> files by URL</li>
              <li>Remote files must allow <strong class="text-base-00">CORS</strong></li>
              <li>Display capped at <strong class="text-base-00">1,000 rows</strong></li>
            </ul>
          </div>

          <!-- Schema Explorer -->
          <div class="bg-base-2 border border-base-1/20 rounded p-5">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-semibold">Schema</h4>
              <button id="refresh-schema-btn"
                      class="text-[11px] text-sol-cyan hover:underline cursor-pointer bg-transparent border-0 font-mono p-0">
                refresh
              </button>
            </div>
            <div id="schema-info" class="text-[12px] text-base-01 leading-relaxed">
              <p class="text-base-1 italic">No tables yet</p>
            </div>
          </div>

          <!-- File Drop Zone -->
          <div id="drop-zone"
               class="bg-base-2 border-2 border-dashed border-base-1/30 rounded p-5 text-center
                      transition-all duration-200 hover:border-sol-cyan/40">
            <p class="text-[12px] text-base-1 leading-relaxed">
              Drop a <strong class="text-base-00">CSV</strong> or <strong class="text-base-00">Parquet</strong> file here to load it as a table
            </p>
            <input type="file" id="file-input" accept=".csv,.parquet,.json,.tsv" class="hidden">
            <button id="browse-btn"
                    class="mt-2 text-[11px] text-sol-cyan hover:underline cursor-pointer bg-transparent border-0 font-mono p-0">
              or browse files
            </button>
          </div>

          <!-- Load from URL -->
          <div class="bg-base-2 border border-base-1/20 rounded p-4">
            <label class="block text-xs text-base-1 mb-1.5 uppercase tracking-wider">Load from URL</label>
            <div class="flex gap-2">
              <input type="text" id="url-input"
                     placeholder="https://example.com/data.csv"
                     class="flex-1 min-w-0 px-2 py-1.5 bg-base-3 border border-base-1/20 rounded text-[12px] text-base-00 font-mono
                            transition-all duration-200
                            focus:outline-none focus:border-sol-cyan focus:ring-[3px] focus:ring-sol-cyan/20">
              <button id="load-url-btn"
                      class="px-3 py-1.5 text-[11px] font-semibold rounded bg-sol-cyan text-base-3
                             transition-all duration-150
                             hover:shadow-[0_4px_12px_rgba(42,161,152,0.3)] hover:-translate-y-0.5
                             active:scale-[0.98]
                             disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none">
                Load
              </button>
            </div>
            <p class="text-[10px] text-base-1 mt-1.5">.csv, .parquet, .json — must allow CORS</p>
          </div>

        </div>
      </aside>

    </div>
  </main>

  <script type="module">
    import * as duckdb from 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm/+esm';

    // =========================================================================
    // State
    // =========================================================================
    let db = null;
    let conn = null;
    let isRunning = false;

    // =========================================================================
    // DOM references
    // =========================================================================
    const editor = document.getElementById('sql-editor');
    const runBtn = document.getElementById('run-btn');
    const clearBtn = document.getElementById('clear-btn');
    const runningBar = document.getElementById('running-bar');
    const resultsContainer = document.getElementById('results-container');
    const resultsThead = document.getElementById('results-thead');
    const resultsTbody = document.getElementById('results-tbody');
    const resultStats = document.getElementById('result-stats');
    const errorContainer = document.getElementById('error-container');
    const errorMessage = document.getElementById('error-message');
    const successContainer = document.getElementById('success-container');
    const successMessage = document.getElementById('success-message');
    const queryInfo = document.getElementById('query-info');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingMsg = document.getElementById('loading-message');
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const examplesList = document.getElementById('examples-list');
    const schemaInfo = document.getElementById('schema-info');
    const refreshSchemaBtn = document.getElementById('refresh-schema-btn');
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const browseBtn = document.getElementById('browse-btn');
    const urlInput = document.getElementById('url-input');
    const loadUrlBtn = document.getElementById('load-url-btn');

    // =========================================================================
    // Example queries
    // =========================================================================
    const examples = [
      {
        name: 'Hello DuckDB',
        sql: `SELECT 42 AS answer, 'Hello DuckDB!' AS greeting;`
      },
      {
        name: 'Generate Series',
        sql: `SELECT *
FROM generate_series(1, 20) AS t(n)
WHERE n % 2 = 0;`
      },
      {
        name: 'Inline Stocks',
        sql: `SELECT * FROM (VALUES
  ('AAPL',  'Apple Inc',       182.52),
  ('MSFT',  'Microsoft',       378.91),
  ('GOOGL', 'Alphabet',        141.80),
  ('AMZN',  'Amazon',          178.25),
  ('NVDA',  'NVIDIA',          875.28),
  ('META',  'Meta Platforms',   484.10),
  ('TSLA',  'Tesla Inc',       177.48)
) AS stocks(ticker, company, price)
ORDER BY price DESC;`
      },
      {
        name: 'Window Functions',
        sql: `WITH sales AS (
  SELECT * FROM (VALUES
    ('Q1', 'North', 150), ('Q1', 'South', 200),
    ('Q2', 'North', 180), ('Q2', 'South', 220),
    ('Q3', 'North', 210), ('Q3', 'South', 190),
    ('Q4', 'North', 240), ('Q4', 'South', 260)
  ) AS t(quarter, region, revenue)
)
SELECT
  quarter, region, revenue,
  SUM(revenue) OVER (
    PARTITION BY region ORDER BY quarter
  ) AS cumulative,
  RANK() OVER (ORDER BY revenue DESC) AS rank
FROM sales;`
      },
      {
        name: 'Remote Parquet',
        sql: `-- AWS CloudFront edge locations (from GitHub)
SELECT
  code, city, country,
  ROUND(latitude, 3) AS lat,
  ROUND(longitude, 3) AS lon
FROM read_parquet(
  'https://raw.githubusercontent.com/tobilg/aws-edge-locations/main/data/aws-edge-locations.parquet'
)
ORDER BY country, city
LIMIT 50;`
      },
      {
        name: 'Remote CSV',
        sql: `-- Iris dataset from GitHub
SELECT
  species,
  sepal_length,
  sepal_width,
  petal_length,
  petal_width
FROM read_csv(
  'https://raw.githubusercontent.com/mwaskom/seaborn-data/master/iris.csv'
)
ORDER BY sepal_length DESC
LIMIT 30;`
      },
      {
        name: 'CSV Aggregation',
        sql: `-- Iris species stats
SELECT
  species,
  COUNT(*) AS n,
  ROUND(AVG(sepal_length), 2) AS avg_sepal_l,
  ROUND(AVG(petal_length), 2) AS avg_petal_l,
  ROUND(STDDEV(sepal_width), 2) AS std_sepal_w
FROM read_csv(
  'https://raw.githubusercontent.com/mwaskom/seaborn-data/master/iris.csv'
)
GROUP BY species
ORDER BY avg_sepal_l DESC;`
      },
      {
        name: 'Pivot Table',
        sql: `WITH data AS (
  SELECT * FROM (VALUES
    (2023, 'Q1', 'Product A', 1200),
    (2023, 'Q2', 'Product A', 1500),
    (2023, 'Q3', 'Product A', 1100),
    (2023, 'Q4', 'Product A', 1800),
    (2023, 'Q1', 'Product B', 800),
    (2023, 'Q2', 'Product B', 950),
    (2023, 'Q3', 'Product B', 1050),
    (2023, 'Q4', 'Product B', 1200)
  ) AS t(year, quarter, product, sales)
)
PIVOT data
ON quarter
USING SUM(sales)
GROUP BY year, product
ORDER BY product;`
      },
      {
        name: 'System Info',
        sql: `SELECT
  version() AS duckdb_version,
  current_date AS today,
  current_timestamp AS now;`
      }
    ];

    // =========================================================================
    // Initialize DuckDB-WASM
    // =========================================================================
    async function initDuckDB() {
      try {
        loadingMsg.textContent = 'Fetching DuckDB bundles...';
        const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
        const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);

        loadingMsg.textContent = 'Starting worker...';
        const workerUrl = URL.createObjectURL(
          new Blob([`importScripts("${bundle.mainWorker}");`], { type: 'text/javascript' })
        );

        const worker = new Worker(workerUrl);
        const logger = new duckdb.ConsoleLogger();
        db = new duckdb.AsyncDuckDB(logger, worker);

        loadingMsg.textContent = 'Instantiating database...';
        await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
        URL.revokeObjectURL(workerUrl);

        loadingMsg.textContent = 'Connecting...';
        conn = await db.connect();

        setStatus('ready', 'Ready');
        loadingOverlay.style.transition = 'opacity 0.3s ease';
        loadingOverlay.style.opacity = '0';
        setTimeout(() => { loadingOverlay.style.display = 'none'; }, 300);

        // Run initial example
        await runQuery();

      } catch (err) {
        setStatus('error', 'Init failed');
        loadingMsg.textContent = 'Error: ' + err.message;
        loadingMsg.style.color = 'var(--color-sol-red)';
        console.error('DuckDB init error:', err);
      }
    }

    // =========================================================================
    // Status indicator
    // =========================================================================
    function setStatus(state, text) {
      statusText.textContent = text;
      statusDot.className = 'w-2 h-2 rounded-full';
      if (state === 'ready') statusDot.classList.add('bg-sol-green');
      else if (state === 'running') statusDot.classList.add('bg-sol-yellow');
      else if (state === 'error') statusDot.classList.add('bg-sol-red');
    }

    // =========================================================================
    // Query execution
    // =========================================================================
    async function runQuery() {
      if (!conn || isRunning) return { ok: false, error: 'Not ready' };

      const sql = editor.value.trim();
      if (!sql) return { ok: false, error: 'Empty query' };

      isRunning = true;
      runBtn.disabled = true;
      setStatus('running', 'Running...');
      runningBar.classList.remove('hidden');
      hideAllResults();

      const startTime = performance.now();
      let result_status;

      try {
        const result = await conn.query(sql);
        const elapsed = ((performance.now() - startTime) / 1000).toFixed(3);
        const columns = result.schema.fields.map(f => f.name);
        const numRows = result.numRows;

        if (columns.length === 0 || numRows === 0 && looksLikeDDL(sql)) {
          successContainer.classList.remove('hidden');
          successMessage.textContent = 'Query executed successfully in ' + elapsed + 's';
          queryInfo.textContent = elapsed + 's';
          refreshSchema();
        } else {
          displayResults(result, columns, numRows, elapsed);
        }

        setStatus('ready', 'Ready');

        // Capture columns and first row for LLM feedback
        let firstRow = null;
        if (columns.length > 0 && numRows > 0) {
          const rows = result.toArray();
          const row0 = rows[0];
          firstRow = {};
          for (const col of columns) {
            const val = row0[col];
            firstRow[col] = val === null ? 'NULL' : String(val);
          }
        }
        result_status = { ok: true, columns, numRows, firstRow };

      } catch (err) {
        const elapsed = ((performance.now() - startTime) / 1000).toFixed(3);
        errorContainer.classList.remove('hidden');
        errorMessage.textContent = err.message;
        queryInfo.textContent = 'Error after ' + elapsed + 's';
        setStatus('error', 'Error');
        setTimeout(() => setStatus('ready', 'Ready'), 3000);
        result_status = { ok: false, error: err.message };
      }

      isRunning = false;
      runBtn.disabled = false;
      runningBar.classList.add('hidden');
      return result_status;
    }

    function looksLikeDDL(sql) {
      const first = sql.replace(/--[^\n]*/g, '').trim().split(/\s+/)[0].toUpperCase();
      return ['CREATE', 'DROP', 'ALTER', 'INSERT', 'UPDATE', 'DELETE', 'COPY', 'LOAD', 'INSTALL', 'SET'].includes(first);
    }

    // =========================================================================
    // Display results
    // =========================================================================
    const MAX_DISPLAY = 1000;

    function displayResults(result, columns, numRows, elapsed) {
      const displayCount = Math.min(numRows, MAX_DISPLAY);

      // Header
      resultsThead.innerHTML = '<tr>' +
        columns.map(c => '<th>' + escapeHtml(c) + '</th>').join('') +
        '</tr>';

      // Body
      const rows = result.toArray();
      const fragments = [];
      for (let i = 0; i < displayCount; i++) {
        const row = rows[i];
        fragments.push('<tr>');
        for (const col of columns) {
          let val = row[col];
          if (val === null || val === undefined) {
            fragments.push('<td class="null-val">NULL</td>');
          } else {
            if (typeof val === 'bigint') val = val.toString();
            else if (typeof val === 'object' && val !== null) {
              // DuckDB returns Decimal/numeric types as objects with valueOf()
              const prim = val.valueOf();
              if (typeof prim === 'number' || typeof prim === 'bigint' || typeof prim === 'string') {
                val = String(prim);
              } else if (val instanceof Date) {
                val = val.toISOString();
              } else {
                val = JSON.stringify(val);
              }
            }
            else val = String(val);
            fragments.push('<td title="' + escapeAttr(val) + '">' + escapeHtml(val) + '</td>');
          }
        }
        fragments.push('</tr>');
      }
      resultsTbody.innerHTML = fragments.join('');

      // Stats
      const truncNote = numRows > MAX_DISPLAY ? ' (showing ' + MAX_DISPLAY + ')' : '';
      resultStats.textContent =
        numRows + ' row' + (numRows !== 1 ? 's' : '') + ' \u00d7 ' +
        columns.length + ' col' + (columns.length !== 1 ? 's' : '') +
        truncNote + ' \u00b7 ' + elapsed + 's';
      queryInfo.textContent = numRows + ' rows \u00b7 ' + elapsed + 's';

      resultsContainer.classList.remove('hidden');
    }

    // =========================================================================
    // Clear all result panels
    // =========================================================================
    function hideAllResults() {
      resultsContainer.classList.add('hidden');
      errorContainer.classList.add('hidden');
      successContainer.classList.add('hidden');
      queryInfo.textContent = '';
    }

    // =========================================================================
    // Helpers
    // =========================================================================
    function escapeHtml(str) {
      const el = document.createElement('span');
      el.textContent = str;
      return el.innerHTML;
    }

    function escapeAttr(str) {
      return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // =========================================================================
    // Schema explorer
    // =========================================================================
    async function refreshSchema() {
      if (!conn) return;
      try {
        const result = await conn.query(
          `SELECT table_name, column_name, data_type
           FROM information_schema.columns
           WHERE table_schema = 'main'
           ORDER BY table_name, ordinal_position`
        );
        const rows = result.toArray();
        if (rows.length === 0) {
          schemaInfo.innerHTML = '<p class="text-base-1 italic">No tables yet</p>';
          return;
        }
        const tables = {};
        for (const row of rows) {
          const tbl = row.table_name;
          if (!tables[tbl]) tables[tbl] = [];
          tables[tbl].push({ col: row.column_name, type: row.data_type });
        }
        let html = '';
        for (const [tbl, cols] of Object.entries(tables)) {
          html += '<div class="mb-3">';
          html += '<p class="text-sol-cyan font-semibold text-[12px]">' + escapeHtml(tbl) + '</p>';
          html += '<ul class="ml-2 mt-1 space-y-0.5">';
          for (const c of cols) {
            html += '<li><span class="text-base-00">' + escapeHtml(c.col) +
                    '</span> <span class="text-base-1">' + escapeHtml(c.type) + '</span></li>';
          }
          html += '</ul></div>';
        }
        schemaInfo.innerHTML = html;
      } catch {
        schemaInfo.innerHTML = '<p class="text-base-1 italic">No tables yet</p>';
      }
      // Sync schema to LLM prompt
      updateSchemaInPrompt();
    }

    // =========================================================================
    // Build example buttons
    // =========================================================================
    function buildExamples() {
      for (const ex of examples) {
        const btn = document.createElement('button');
        btn.className = 'example-btn';
        btn.textContent = ex.name;
        btn.addEventListener('click', () => {
          editor.value = ex.sql;
          editor.focus();
        });
        examplesList.appendChild(btn);
      }
    }

    // =========================================================================
    // File loading (drag & drop + browse)
    // =========================================================================
    async function loadFile(file) {
      if (!db || !conn) return;

      const name = file.name.replace(/\.[^.]+$/, '').replace(/[^a-zA-Z0-9_]/g, '_');
      const ext = file.name.split('.').pop().toLowerCase();

      setStatus('running', 'Loading file...');

      try {
        const buffer = await file.arrayBuffer();
        await db.registerFileBuffer(file.name, new Uint8Array(buffer));

        let sql;
        if (ext === 'parquet') {
          sql = `CREATE OR REPLACE TABLE "${name}" AS SELECT * FROM read_parquet('${file.name}')`;
        } else if (ext === 'csv' || ext === 'tsv') {
          sql = `CREATE OR REPLACE TABLE "${name}" AS SELECT * FROM read_csv('${file.name}', auto_detect=true)`;
        } else if (ext === 'json') {
          sql = `CREATE OR REPLACE TABLE "${name}" AS SELECT * FROM read_json_auto('${file.name}')`;
        } else {
          throw new Error('Unsupported file type: .' + ext);
        }

        await conn.query(sql);
        editor.value = `SELECT * FROM "${name}" LIMIT 100;`;
        setStatus('ready', 'Ready');
        await refreshSchema();
        await runQuery();

      } catch (err) {
        setStatus('error', 'Load failed');
        hideAllResults();
        errorContainer.classList.remove('hidden');
        errorMessage.textContent = 'File load error: ' + err.message;
        setTimeout(() => setStatus('ready', 'Ready'), 3000);
      }
    }

    // =========================================================================
    // URL loading
    // =========================================================================
    async function loadURL() {
      if (!db || !conn) return;

      const url = urlInput.value.trim();
      if (!url) return;

      // Validate URL
      let parsed;
      try {
        parsed = new URL(url);
      } catch {
        errorContainer.classList.remove('hidden');
        errorMessage.textContent = 'Invalid URL. Please enter a full URL starting with https://';
        return;
      }

      // Determine file type from URL path
      const path = parsed.pathname.toLowerCase();
      let ext;
      if (path.endsWith('.parquet')) ext = 'parquet';
      else if (path.endsWith('.csv')) ext = 'csv';
      else if (path.endsWith('.tsv')) ext = 'tsv';
      else if (path.endsWith('.json')) ext = 'json';
      else {
        errorContainer.classList.remove('hidden');
        errorMessage.textContent = 'Could not detect file type from URL. The URL must end in .csv, .parquet, .tsv, or .json';
        return;
      }

      // Derive table name from filename in URL
      const filename = parsed.pathname.split('/').pop();
      const name = filename.replace(/\.[^.]+$/, '').replace(/[^a-zA-Z0-9_]/g, '_') || 'remote_data';

      setStatus('running', 'Loading URL...');
      loadUrlBtn.disabled = true;
      hideAllResults();

      try {
        // First check CORS with a HEAD request
        try {
          await fetch(url, { method: 'HEAD', mode: 'cors' });
        } catch {
          throw new Error(
            `CORS error: The server at ${parsed.hostname} does not allow cross-origin requests. ` +
            `The file cannot be loaded directly in the browser because the server does not include ` +
            `the "Access-Control-Allow-Origin" header in its response. ` +
            `Try downloading the file and dropping it into the drop zone instead, ` +
            `or use a URL from a CORS-friendly host (e.g. raw.githubusercontent.com).`
          );
        }

        let sql;
        if (ext === 'parquet') {
          sql = `CREATE OR REPLACE TABLE "${name}" AS SELECT * FROM read_parquet('${url}')`;
        } else if (ext === 'csv' || ext === 'tsv') {
          sql = `CREATE OR REPLACE TABLE "${name}" AS SELECT * FROM read_csv('${url}', auto_detect=true)`;
        } else {
          sql = `CREATE OR REPLACE TABLE "${name}" AS SELECT * FROM read_json_auto('${url}')`;
        }

        await conn.query(sql);
        editor.value = `SELECT * FROM "${name}" LIMIT 100;`;
        setStatus('ready', 'Ready');
        await refreshSchema();
        await runQuery();

      } catch (err) {
        setStatus('error', 'Load failed');
        hideAllResults();
        errorContainer.classList.remove('hidden');
        errorMessage.textContent = err.message;
        setTimeout(() => setStatus('ready', 'Ready'), 3000);
      }

      loadUrlBtn.disabled = false;
    }

    // =========================================================================
    // Event listeners
    // =========================================================================
    runBtn.addEventListener('click', runQuery);

    clearBtn.addEventListener('click', () => {
      editor.value = '';
      hideAllResults();
      editor.focus();
    });

    refreshSchemaBtn.addEventListener('click', refreshSchema);

    editor.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        runQuery();
        return;
      }
      if (e.key === 'Tab') {
        e.preventDefault();
        const start = editor.selectionStart;
        const end = editor.selectionEnd;
        editor.value = editor.value.substring(0, start) + '  ' + editor.value.substring(end);
        editor.selectionStart = editor.selectionEnd = start + 2;
      }
    });

    // Drag & drop
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = 'var(--color-sol-cyan)';
      dropZone.style.background = 'rgba(42, 161, 152, 0.05)';
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.style.borderColor = '';
      dropZone.style.background = '';
    });
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '';
      dropZone.style.background = '';
      if (e.dataTransfer.files.length > 0) {
        loadFile(e.dataTransfer.files[0]);
      }
    });

    browseBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => {
      if (fileInput.files.length > 0) {
        loadFile(fileInput.files[0]);
      }
    });

    loadUrlBtn.addEventListener('click', loadURL);
    urlInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        loadURL();
      }
    });

    // =========================================================================
    // LLM State
    // =========================================================================
    let llmWorker = null;
    let llmReady = false;
    let isGenerating = false;
    let llmGenerateResolve = null;
    let llmUseWebGPU = localStorage.getItem('sqlLlmUseWebGPU') !== 'false';

    // Thinking state
    let llmThinkingContent = '';
    let llmSummaryContent = '';
    let llmIsInsideThinkBlock = false;

    // LLM DOM references
    const nlInput = document.getElementById('nl-input');
    const llmGenerateBtn = document.getElementById('llm-generate-btn');
    const llmStopBtn = document.getElementById('llm-stop-btn');
    const llmLoadingMessage = document.getElementById('llm-loading-message');
    const llmProgressContainer = document.getElementById('llm-progress-container');
    const llmWebGPUToggle = document.getElementById('llm-webgpu-toggle');
    const llmErrorContainer = document.getElementById('llm-error-container');
    const llmErrorMessage = document.getElementById('llm-error-message');
    const llmThinkingSection = document.getElementById('llm-thinking-section');
    const llmThinkingToggle = document.getElementById('llm-thinking-toggle');
    const llmThinkingChevron = document.getElementById('llm-thinking-chevron');
    const llmThinkingStatus = document.getElementById('llm-thinking-status');
    const llmThinkingContentEl = document.getElementById('llm-thinking-content');
    const llmThinkingOutput = document.getElementById('llm-thinking-output');
    const llmStreamingSection = document.getElementById('llm-streaming-section');
    const llmStreamingOutput = document.getElementById('llm-streaming-output');
    const llmStreamingLabel = document.getElementById('llm-streaming-label');
    const llmTpsDisplay = document.getElementById('llm-tps-display');
    // Tab elements
    const llmTabQuestion = document.getElementById('llm-tab-question');
    const llmTabPrompt = document.getElementById('llm-tab-prompt');
    const llmTabContentQuestion = document.getElementById('llm-tab-content-question');
    const llmTabContentPrompt = document.getElementById('llm-tab-content-prompt');
    const llmPromptInput = document.getElementById('llm-prompt-input');
    const llmResetPromptBtn = document.getElementById('llm-reset-prompt-btn');

    // =========================================================================
    // LLM: Think Tag Parser
    // =========================================================================
    function parseThinkContent(fullText) {
      if (!fullText.startsWith('<think>')) {
        return { thinking: '', summary: fullText, isInsideThink: false };
      }
      const afterOpen = fullText.slice('<think>'.length);
      const closeIndex = afterOpen.indexOf('</think>');
      if (closeIndex === -1) {
        return { thinking: afterOpen.trim(), summary: '', isInsideThink: true };
      }
      return {
        thinking: afterOpen.slice(0, closeIndex).trim(),
        summary: afterOpen.slice(closeIndex + '</think>'.length).trim(),
        isInsideThink: false
      };
    }

    // =========================================================================
    // LLM: Thinking Section UI
    // =========================================================================
    function llmUpdateThinkingUI(thinking, isComplete) {
      if (thinking) {
        llmThinkingSection.classList.remove('hidden');
        llmThinkingOutput.textContent = thinking;
        if (isComplete) {
          llmThinkingStatus.textContent = '(complete)';
          llmCollapseThinking();
        } else {
          llmThinkingStatus.textContent = '(reasoning...)';
          llmExpandThinking();
        }
      }
    }

    function llmExpandThinking() {
      llmThinkingContentEl.classList.remove('hidden');
      llmThinkingChevron.classList.add('expanded');
    }

    function llmCollapseThinking() {
      llmThinkingContentEl.classList.add('hidden');
      llmThinkingChevron.classList.remove('expanded');
    }

    function llmToggleThinking() {
      llmThinkingContentEl.classList.toggle('hidden');
      llmThinkingChevron.classList.toggle('expanded');
    }

    // =========================================================================
    // LLM: Prompt Template
    // =========================================================================
    const LLM_DEFAULT_PROMPT = `You are a SQL query generator for DuckDB. Generate a single SQL query that answers the user's question.

{schema}

DuckDB SQL reference:
- Aggregations: SELECT agg(col) FROM t — use SUM(), MIN(), MAX(), AVG(), COUNT(*), COUNT(DISTINCT col)
- Counting: COUNT(*) counts all rows; COUNT(col) counts non-null; COUNT(DISTINCT col) counts unique values
- Averages: AVG(col) returns the mean; combine with GROUP BY for per-group averages
- Group By: SELECT col, AGG(val) FROM t GROUP BY col — groups rows; use HAVING to filter groups
- Pivot: PIVOT t ON pivot_col USING AGG(val) — turns row values into columns; use IN ('a','b') to select specific values

Rules:
- Output ONLY the SQL query, no explanations or markdown
- Use DuckDB SQL syntax
- Do not wrap the SQL in code fences

User question: {question}`;

    let llmCurrentSchema = 'No tables exist yet. You can use DuckDB built-in functions, generate_series(), VALUES clauses, or read_csv()/read_parquet() with URLs.';

    function getLLMPromptTemplate() {
      return llmPromptInput.value || LLM_DEFAULT_PROMPT;
    }

    function buildSQLPrompt(question) {
      const template = getLLMPromptTemplate();
      return template.split('{question}').join(question).split('{schema}').join(llmCurrentSchema);
    }

    async function updateSchemaInPrompt() {
      if (!conn) return;
      try {
        const result = await conn.query(
          `SELECT table_name, column_name, data_type
           FROM information_schema.columns
           WHERE table_schema = 'main'
           ORDER BY table_name, ordinal_position`
        );
        const rows = result.toArray();
        if (rows.length === 0) {
          llmCurrentSchema = 'No tables exist yet. You can use DuckDB built-in functions, generate_series(), VALUES clauses, or read_csv()/read_parquet() with URLs.';
          return;
        }

        const tables = {};
        for (const row of rows) {
          const tbl = row.table_name;
          if (!tables[tbl]) tables[tbl] = [];
          tables[tbl].push(`${row.column_name} (${row.data_type})`);
        }

        let schema = 'Available tables:';
        for (const [tbl, cols] of Object.entries(tables)) {
          schema += `\n\nTable "${tbl}":\n  Columns: ${cols.join(', ')}`;
        }
        llmCurrentSchema = schema;
      } catch {
        // keep existing schema text
      }
    }

    function extractSQL(output) {
      let sql = output.trim();
      // Strip markdown code fences if present
      sql = sql.replace(/^```(?:sql)?\s*\n?/i, '').replace(/\n?```\s*$/i, '');
      return sql.trim();
    }

    // =========================================================================
    // LLM: Worker Communication
    // =========================================================================
    function initLLMWorker() {
      llmWorker = new Worker('./sql-query-worker.js?v=' + Date.now(), { type: 'module' });
      llmWebGPUToggle.checked = llmUseWebGPU;

      llmWorker.addEventListener('message', (e) => {
        const { status, nodeId, output, tps, numTokens, data, file, name, loaded, total } = e.data;

        switch (status) {
          case 'webgpu-ok':
            llmLoadingMessage.textContent = 'Loading model (WebGPU)...';
            llmLoadModel();
            break;

          case 'wasm-ok':
            llmLoadingMessage.textContent = 'Loading model (CPU/WASM)...';
            llmLoadModel();
            break;

          case 'loading':
            llmLoadingMessage.textContent = data;
            break;

          case 'initiate':
          case 'progress': {
            const fileName = file || name;
            const existing = Array.from(llmProgressContainer.children).find(
              el => el.dataset.file === fileName
            );
            const isCached = status === 'progress' && loaded === total && total > 0;

            if (!existing) {
              const div = document.createElement('div');
              div.dataset.file = fileName;
              div.className = 'text-[11px] inline-flex items-center gap-1 ml-1';
              div.innerHTML = `
                <span class="truncate max-w-[120px]">${fileName.split('/').pop()}</span>
                <span class="progress-pct">${isCached ? 'cached' : '0%'}</span>
              `;
              llmProgressContainer.appendChild(div);
            }

            const container = llmProgressContainer.querySelector(`[data-file="${fileName}"]`);
            if (container && loaded !== undefined && total !== undefined) {
              const pct = Math.round((loaded / total) * 100);
              const cachedNow = loaded === total && total > 0;
              container.querySelector('.progress-pct').textContent = cachedNow ? 'cached' : `${pct}%`;
            }
            break;
          }

          case 'done': {
            const doneEl = llmProgressContainer.querySelector(`[data-file="${file || name}"]`);
            if (doneEl) doneEl.remove();
            break;
          }

          case 'ready':
            llmReady = true;
            const modeLabel = llmUseWebGPU ? 'WebGPU' : 'CPU';
            llmLoadingMessage.textContent = `Model ready (${modeLabel})`;
            llmProgressContainer.innerHTML = '';
            llmGenerateBtn.disabled = !nlInput.value.trim();
            break;

          case 'start':
            llmStreamingOutput.textContent = '';
            break;

          case 'update': {
            const { thinking, summary, isInsideThink } = parseThinkContent(output);
            llmThinkingContent = thinking;
            llmSummaryContent = summary;
            llmIsInsideThinkBlock = isInsideThink;

            const thinkingComplete = !isInsideThink && thinking.length > 0;
            llmUpdateThinkingUI(thinking, thinkingComplete);

            if (isInsideThink) {
              llmStreamingOutput.textContent = '';
            } else {
              llmStreamingOutput.textContent = summary;
            }

            if (tps) {
              llmTpsDisplay.textContent = `${tps.toFixed(1)} tokens/sec`;
            }
            break;
          }

          case 'complete':
            if (llmGenerateResolve) {
              const finalParsed = parseThinkContent(output);
              llmThinkingContent = finalParsed.thinking;
              llmGenerateResolve(finalParsed.summary || output);
              llmGenerateResolve = null;
            }
            break;

          case 'error': {
            console.error('LLM Worker error:', data);
            llmErrorContainer.classList.remove('hidden');
            llmErrorMessage.textContent = data;

            if (llmGenerateResolve) {
              llmGenerateResolve(null);
              llmGenerateResolve = null;
            }

            llmResetGenerationUI();
            setTimeout(() => llmErrorContainer.classList.add('hidden'), 8000);
            break;
          }
        }
      });

      if (llmUseWebGPU) {
        llmWorker.postMessage({ type: 'check' });
      } else {
        llmLoadingMessage.textContent = 'WebGPU disabled, using CPU...';
        llmWorker.postMessage({ type: 'check-wasm' });
      }
    }

    function llmLoadModel() {
      const device = llmUseWebGPU ? 'webgpu' : 'wasm';
      llmWorker.postMessage({ type: 'load', data: { device } });
    }

    async function llmGenerate(prompt) {
      return new Promise((resolve) => {
        llmGenerateResolve = resolve;
        llmWorker.postMessage({
          type: 'generate',
          data: { nodeId: 'sql', prompt, maxNewTokens: 2048 },
        });
      });
    }

    // =========================================================================
    // LLM: Generation Pipeline
    // =========================================================================
    const LLM_MAX_RETRIES = 2;

    async function generateSQLFromNL() {
      const question = nlInput.value.trim();
      if (!question || !llmReady || isGenerating) return;

      isGenerating = true;

      // Reset state
      llmThinkingContent = '';
      llmSummaryContent = '';
      llmIsInsideThinkBlock = false;
      llmThinkingSection.classList.add('hidden');
      llmErrorContainer.classList.add('hidden');

      // Update UI
      llmGenerateBtn.classList.add('hidden');
      llmStopBtn.classList.remove('hidden');
      llmStreamingSection.classList.remove('hidden');
      llmStreamingOutput.textContent = '';
      llmStreamingLabel.textContent = 'Generating SQL';
      llmTpsDisplay.textContent = '-- tokens/sec';

      let prompt = buildSQLPrompt(question);
      let lastSQL = '';
      let lastFeedback = '';

      for (let attempt = 0; attempt <= LLM_MAX_RETRIES; attempt++) {
        // For retries, augment the prompt with feedback
        if (attempt > 0) {
          llmThinkingContent = '';
          llmSummaryContent = '';
          llmIsInsideThinkBlock = false;
          llmStreamingOutput.textContent = '';
          llmTpsDisplay.textContent = '-- tokens/sec';

          prompt = buildSQLPrompt(question) + '\n\n' + lastFeedback +
            '\n\nPlease fix the SQL and try again. Output ONLY the corrected SQL query.';
        }

        const output = await llmGenerate(prompt);

        if (!output) break; // interrupted or LLM error

        // Finalize thinking UI
        if (llmThinkingContent) {
          llmUpdateThinkingUI(llmThinkingContent, true);
        }

        // Extract SQL, put it in editor, and auto-run
        const sql = extractSQL(output);
        editor.value = sql;
        lastSQL = sql;

        const result = await runQuery();

        if (!result.ok) {
          // Query errored — build error feedback for retry
          lastFeedback = `The previous SQL query:\n${lastSQL}\n\nReturned this error:\n${result.error}`;
          if (attempt < LLM_MAX_RETRIES) {
            llmStreamingLabel.textContent = 'Correcting';
            llmStreamingOutput.textContent = `SQL error, retrying (${attempt + 1}/${LLM_MAX_RETRIES})...`;
            llmStreamingSection.classList.remove('hidden');
          }
          continue;
        }

        // Query succeeded — verify results match the question
        if (attempt < LLM_MAX_RETRIES && result.columns && result.firstRow) {
          const resultSummary = `The query ran successfully and returned ${result.numRows} row(s).\n` +
            `Columns: ${result.columns.join(', ')}\n` +
            `First row: ${result.columns.map(c => c + '=' + result.firstRow[c]).join(', ')}`;

          // Ask LLM to verify
          llmThinkingContent = '';
          llmSummaryContent = '';
          llmIsInsideThinkBlock = false;
          llmStreamingLabel.textContent = 'Checking Results';
          llmStreamingOutput.textContent = 'Verifying results...';
          llmStreamingSection.classList.remove('hidden');
          llmTpsDisplay.textContent = '-- tokens/sec';

          const verifyPrompt = buildSQLPrompt(question) +
            `\n\nThe SQL query that was executed:\n${lastSQL}\n\n${resultSummary}\n\n` +
            `Check if these results correctly answer the user's question. ` +
            `If the results look correct, respond with exactly: Done\n` +
            `If the results are wrong, respond with the corrected SQL query only.`;

          const verifyOutput = await llmGenerate(verifyPrompt);

          if (!verifyOutput) break;

          if (llmThinkingContent) {
            llmUpdateThinkingUI(llmThinkingContent, true);
          }

          const cleaned = extractSQL(verifyOutput);
          if (cleaned.toUpperCase().replace(/[^A-Z]/g, '') === 'DONE') {
            editor.value = lastSQL; // restore the working SQL
            break; // verified correct
          }

          // LLM provided a corrected query — run it
          lastFeedback = `${resultSummary}\n\nThe results did not correctly answer the question. You provided a corrected query.`;
          editor.value = cleaned;
          lastSQL = cleaned;

          const retryResult = await runQuery();
          if (retryResult.ok) break;

          // Corrected query also failed
          lastFeedback = `The corrected SQL query:\n${cleaned}\n\nReturned this error:\n${retryResult.error}`;
          if (attempt < LLM_MAX_RETRIES) {
            llmStreamingLabel.textContent = 'Correcting';
            llmStreamingOutput.textContent = `SQL error, retrying (${attempt + 1}/${LLM_MAX_RETRIES})...`;
            llmStreamingSection.classList.remove('hidden');
          }
          continue;
        }

        break; // success, no more retries available or DDL query
      }

      llmResetGenerationUI();
    }

    function llmResetGenerationUI() {
      isGenerating = false;
      llmStreamingLabel.textContent = 'Generating SQL';
      llmGenerateBtn.classList.remove('hidden');
      llmStopBtn.classList.add('hidden');
      llmStreamingSection.classList.add('hidden');
      llmGenerateBtn.disabled = !llmReady || !nlInput.value.trim();
    }

    function llmStopGeneration() {
      llmWorker.postMessage({ type: 'interrupt' });
      llmResetGenerationUI();
    }

    // =========================================================================
    // LLM: Event Listeners
    // =========================================================================
    nlInput.addEventListener('input', () => {
      llmGenerateBtn.disabled = !llmReady || !nlInput.value.trim();
    });

    nlInput.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        generateSQLFromNL();
      }
    });

    llmGenerateBtn.addEventListener('click', generateSQLFromNL);
    llmStopBtn.addEventListener('click', llmStopGeneration);
    llmThinkingToggle.addEventListener('click', llmToggleThinking);

    // Tab switching
    function llmSwitchTab(tab) {
      const isQuestion = tab === 'question';
      llmTabContentQuestion.classList.toggle('hidden', !isQuestion);
      llmTabContentPrompt.classList.toggle('hidden', isQuestion);

      llmTabQuestion.className = isQuestion
        ? 'px-3 py-1 text-xs font-semibold rounded bg-base-3 text-base-00 border border-base-1/20 transition-all duration-150 cursor-pointer'
        : 'px-3 py-1 text-xs font-semibold rounded bg-transparent text-base-1 border border-transparent transition-all duration-150 cursor-pointer hover:text-base-00';
      llmTabPrompt.className = !isQuestion
        ? 'px-3 py-1 text-xs font-semibold rounded bg-base-3 text-base-00 border border-base-1/20 transition-all duration-150 cursor-pointer'
        : 'px-3 py-1 text-xs font-semibold rounded bg-transparent text-base-1 border border-transparent transition-all duration-150 cursor-pointer hover:text-base-00';
    }

    llmTabQuestion.addEventListener('click', () => llmSwitchTab('question'));
    llmTabPrompt.addEventListener('click', () => llmSwitchTab('prompt'));

    // Prompt persistence
    llmPromptInput.value = localStorage.getItem('sqlLlmPromptTemplate') || LLM_DEFAULT_PROMPT;

    llmPromptInput.addEventListener('input', () => {
      localStorage.setItem('sqlLlmPromptTemplate', llmPromptInput.value);
    });

    llmResetPromptBtn.addEventListener('click', () => {
      llmPromptInput.value = LLM_DEFAULT_PROMPT;
      localStorage.removeItem('sqlLlmPromptTemplate');
    });

    llmWebGPUToggle.addEventListener('change', (e) => {
      llmUseWebGPU = e.target.checked;
      localStorage.setItem('sqlLlmUseWebGPU', llmUseWebGPU);

      if (llmReady) {
        if (confirm('Changing this setting requires reloading the page. Reload now?')) {
          window.location.reload();
        } else {
          e.target.checked = !llmUseWebGPU;
          llmUseWebGPU = !llmUseWebGPU;
          localStorage.setItem('sqlLlmUseWebGPU', llmUseWebGPU);
        }
      }
    });

    // =========================================================================
    // Init
    // =========================================================================
    buildExamples();
    initDuckDB();
    initLLMWorker();
  </script>
</body>
</html>

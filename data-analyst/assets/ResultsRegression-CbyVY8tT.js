import{r,j as n}from"./charts-Bz0zeynE.js";import{u as H,a as K,g as B}from"./index-B3AZi7YT.js";import"./mermaid-C0ScUPTA.js";import"./duckdb-C5iauSJp.js";let b=null;function Y(){return b||(b=new Worker(new URL(""+new URL("pyodide-worker-DDJfW5uh.js",import.meta.url).href,import.meta.url),{type:"module"})),b}const G={name:"choose_regression_columns",description:"Choose the target column and columns to ignore for regression analysis.",parameters:{type:"object",properties:{target_column:{type:"string",description:"The column to use as the regression target (dependent variable)"},ignore_columns:{type:"string",description:"Comma-separated list of column names to ignore during regression (empty string if none)"}},required:["target_column","ignore_columns"]}},O={fontSize:11,fontFamily:"'Cousine', 'Monaco', 'Consolas', monospace",textTransform:"uppercase",letterSpacing:"0.05em",color:"var(--base-1)"},J={display:"flex",flexDirection:"column",gap:"4px",maxHeight:200,overflowY:"auto",fontSize:12,fontFamily:"'Cousine', 'Monaco', 'Consolas', monospace",color:"var(--base-00)",marginTop:4,padding:"4px 0"},Q={padding:"6px 16px",background:"var(--sol-cyan)",color:"var(--base-3)",border:"1px solid var(--sol-cyan)",borderRadius:4,fontSize:12,fontFamily:"'Cousine', 'Monaco', 'Consolas', monospace",cursor:"pointer",textTransform:"uppercase",letterSpacing:"0.05em",marginTop:8};function ee({queryResult:t,workerRef:S,onTokenUsage:k}){const[P,u]=r.useState(!0),[w,p]=r.useState("llm"),[z,l]=r.useState(""),[U,C]=r.useState(""),[j,g]=r.useState(null),[m,L]=r.useState(""),[f,h]=r.useState(new Set),c=r.useRef(0),E=H(),[_]=K("sql_gen_selected_model",""),y=r.useRef(E);y.current=E;const M=r.useRef(S);M.current=S;const T=r.useRef(k);T.current=k,r.useEffect(()=>{const e=++c.current;async function o(){u(!0),p("llm"),g(null),C("");try{const s=y.current.find(a=>`${a.providerId}::${a.model}`===_)??y.current[0];if(!s)throw new Error("No LLM model configured. Enable a provider in Settings and select a model.");const x={type:s.providerType,endpoint:s.endpoint,apiKey:s.apiKey,model:s.model},v=`We are doing regression analysis. We have OneHotEncoder for non-numeric columns.

Looking at this table schema tell me 2 things:

    what would be the target of a regression?
    what columns should be ignored during a regression?

${t.columns.map(a=>`  - ${a} (${t.columnTypes[a]??"unknown"})`).join(`
`)}

call the choose_regression_columns function with the output`;if(l("Asking LLM to choose regression columns…"),e!==c.current)return;const i=await B({provider:x,systemPrompt:"You are a data science assistant helping with regression analysis. Use the provided tool to return your answer.",messages:[{role:"user",content:v}],tools:[G],maxTokens:1024,worker:M.current?.current??null,onTokenUsage:T.current});if(e!==c.current)return;if(i.functionName!=="choose_regression_columns")throw new Error(`Unexpected tool call: ${i.functionName}`);const I=String(i.arguments.target_column??""),R=String(i.arguments.ignore_columns??""),F=R?R.split(",").map(a=>a.trim()).filter(Boolean):[],N=t.columns.includes(I)?I:t.columns[0],A=F.filter(a=>t.columns.includes(a)&&a!==N);L(N),h(new Set(A)),p("configure"),u(!1),l("")}catch(s){if(e!==c.current)return;g(s instanceof Error?s.message:String(s)),u(!1),l("")}}o()},[t,_]);const W=r.useCallback(async()=>{const e=++c.current;u(!0),p("regression"),g(null),l("Starting Python regression analysis…");try{const o=Y();await new Promise((s,x)=>{const d=v=>{if(e!==c.current){o.removeEventListener("message",d),s();return}const i=v.data;switch(i.status){case"loading-pyodide":l("Loading Python runtime (Pyodide)…");break;case"loading-packages":l("Loading Python packages (numpy, pandas, scikit-learn)…");break;case"progress":l(i.message??"");break;case"complete":o.removeEventListener("message",d),C(i.output??""),s();break;case"error":o.removeEventListener("message",d),x(new Error(i.error??"Unknown worker error"));break}};o.addEventListener("message",d),o.postMessage({type:"run",data:{targetColumn:m,ignoreColumns:Array.from(f),columns:t.columns,rows:t.rows}})})}catch(o){if(e!==c.current)return;g(o instanceof Error?o.message:String(o))}finally{e===c.current&&(u(!1),l(""))}},[m,f,t]),$=r.useCallback(e=>{h(o=>{const s=new Set(o);return s.has(e)?s.delete(e):s.add(e),s})},[]),D=r.useCallback(e=>{L(e),h(o=>{if(!o.has(e))return o;const s=new Set(o);return s.delete(e),s})},[]);if(P){const e=w==="llm"?"Analysing columns":"Running regression";return n.jsxs("div",{className:"duckdb-chart-message",style:{flexDirection:"column",gap:8},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[n.jsx("span",{className:"sql-gen-thinking-throbber"}),n.jsx("span",{style:{fontWeight:600},children:e})]}),n.jsx("div",{children:z||"Initializing…"})]})}return j?n.jsx("div",{className:"duckdb-chart-message",style:{color:"var(--sol-red, #dc322f)"},children:j}):w==="configure"?n.jsx("div",{style:{padding:16},children:n.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:16},children:[n.jsx("div",{children:n.jsxs("label",{style:{...O,display:"flex",alignItems:"center",gap:6},children:["Target Column",n.jsx("select",{value:m,onChange:e=>D(e.target.value),style:{padding:"4px 8px",background:"var(--base-2)",border:"1px solid rgba(147, 161, 161, 0.2)",borderRadius:4,fontSize:12,color:"var(--base-00)",fontFamily:"'Cousine', 'Monaco', 'Consolas', monospace"},children:t.columns.map(e=>n.jsx("option",{value:e,children:e},e))})]})}),n.jsxs("div",{children:[n.jsx("div",{style:O,children:"Columns to Ignore"}),n.jsx("div",{style:J,children:t.columns.filter(e=>e!==m).map(e=>n.jsxs("label",{style:{display:"flex",alignItems:"center",gap:4,cursor:"pointer"},children:[n.jsx("input",{type:"checkbox",checked:f.has(e),onChange:()=>$(e),style:{accentColor:"var(--sol-cyan)"}}),n.jsx("span",{children:e}),n.jsxs("span",{style:{color:"var(--base-1)",fontSize:10},children:["(",t.columnTypes[e]??"unknown",")"]})]},e))})]}),n.jsx("div",{children:n.jsx("button",{onClick:()=>{W()},style:Q,children:"Run Regression"})})]})}):n.jsx("div",{style:{padding:16},children:n.jsx("pre",{style:{fontFamily:"'Cousine', 'Monaco', 'Consolas', monospace",fontSize:13,color:"var(--base-00)",whiteSpace:"pre-wrap",margin:0},children:U})})}export{ee as default};

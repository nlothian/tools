var ps=Object.defineProperty;var ys=(r,e,t)=>e in r?ps(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var u=(r,e,t)=>ys(r,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const l of n.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function t(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(a){if(a.ep)return;a.ep=!0;const n=t(a);fetch(a.href,n)}})();const ws=6364136223846793005n,vs=0xda3e39cb94b95bdbn,bs=0xffffffffffffffffn,Es=1/16777216;class Wt{constructor(e=0){u(this,"state");u(this,"increment");this.increment=vs,this.state=0n,this.randSeed(e)}randSeed(e){const t=Wt.normalizeUint32(e,"Seed");this.state=BigInt(t)}randU32(){const e=this.state;this.state=e*ws+this.increment&bs;const t=Number((e>>18n^e)>>27n)>>>0,i=Number(e>>59n)&31;return(t>>>i|t<<(-i&31))>>>0}randRange(e){const t=Wt.normalizeUint32(e,"Range limit"),a=BigInt(this.randU32())*BigInt(t);return Number(a>>32n)>>>0}randFloat(){return(this.randU32()>>>8)*Es}static normalizeUint32(e,t){if(!Number.isInteger(e)||e<0||e>4294967295)throw new RangeError(`${t} must be a 32-bit unsigned integer.`);return e>>>0}}var re=Uint8Array,it=Uint16Array,Ts=Int32Array,Rn=new re([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Ln=new re([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),_s=new re([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Fn=function(r,e){for(var t=new it(31),i=0;i<31;++i)t[i]=e+=1<<r[i-1];for(var a=new Ts(t[30]),i=1;i<30;++i)for(var n=t[i];n<t[i+1];++n)a[n]=n-t[i]<<5|i;return{b:t,r:a}},kn=Fn(Rn,2),Bn=kn.b,Ss=kn.r;Bn[28]=258,Ss[258]=28;var As=Fn(Ln,0),Ms=As.b,Mr=new it(32768);for(var O=0;O<32768;++O){var ke=(O&43690)>>1|(O&21845)<<1;ke=(ke&52428)>>2|(ke&13107)<<2,ke=(ke&61680)>>4|(ke&3855)<<4,Mr[O]=((ke&65280)>>8|(ke&255)<<8)>>1}var Et=function(r,e,t){for(var i=r.length,a=0,n=new it(e);a<i;++a)r[a]&&++n[r[a]-1];var l=new it(e);for(a=1;a<e;++a)l[a]=l[a-1]+n[a-1]<<1;var d;if(t){d=new it(1<<e);var v=15-e;for(a=0;a<i;++a)if(r[a])for(var b=a<<4|r[a],C=e-r[a],E=l[r[a]-1]++<<C,A=E|(1<<C)-1;E<=A;++E)d[Mr[E]>>v]=b}else for(d=new it(i),a=0;a<i;++a)r[a]&&(d[a]=Mr[l[r[a]-1]++]>>15-r[a]);return d},_t=new re(288);for(var O=0;O<144;++O)_t[O]=8;for(var O=144;O<256;++O)_t[O]=9;for(var O=256;O<280;++O)_t[O]=7;for(var O=280;O<288;++O)_t[O]=8;var In=new re(32);for(var O=0;O<32;++O)In[O]=5;var Cs=Et(_t,9,1),Ps=Et(In,5,1),lr=function(r){for(var e=r[0],t=1;t<r.length;++t)r[t]>e&&(e=r[t]);return e},ge=function(r,e,t){var i=e/8|0;return(r[i]|r[i+1]<<8)>>(e&7)&t},fr=function(r,e){var t=e/8|0;return(r[t]|r[t+1]<<8|r[t+2]<<16)>>(e&7)},Rs=function(r){return(r+7)/8|0},Wr=function(r,e,t){return(e==null||e<0)&&(e=0),(t==null||t>r.length)&&(t=r.length),new re(r.subarray(e,t))},Ls=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],ue=function(r,e,t){var i=new Error(e||Ls[r]);if(i.code=r,Error.captureStackTrace&&Error.captureStackTrace(i,ue),!t)throw i;return i},Fs=function(r,e,t,i){var a=r.length,n=i?i.length:0;if(!a||e.f&&!e.l)return t||new re(0);var l=!t,d=l||e.i!=2,v=e.i;l&&(t=new re(a*3));var b=function(be){var Ze=t.length;if(be>Ze){var Qe=new re(Math.max(Ze*2,be));Qe.set(t),t=Qe}},C=e.f||0,E=e.p||0,A=e.b||0,$=e.l,K=e.d,q=e.m,U=e.n,x=a*8;do{if(!$){C=ge(r,E,1);var Ke=ge(r,E+1,3);if(E+=3,Ke)if(Ke==1)$=Cs,K=Ps,q=9,U=5;else if(Ke==2){var $e=ge(r,E,31)+257,xe=ge(r,E+10,15)+4,j=$e+ge(r,E+5,31)+1;E+=14;for(var Ce=new re(j),he=new re(19),Y=0;Y<xe;++Y)he[_s[Y]]=ge(r,E+Y*3,7);E+=xe*3;for(var We=lr(he),lt=(1<<We)-1,ft=Et(he,We,1),Y=0;Y<j;){var qe=ft[ge(r,E,lt)];E+=qe&15;var H=qe>>4;if(H<16)Ce[Y++]=H;else{var ee=0,Pe=0;for(H==16?(Pe=3+ge(r,E,3),E+=2,ee=Ce[Y-1]):H==17?(Pe=3+ge(r,E,7),E+=3):H==18&&(Pe=11+ge(r,E,127),E+=7);Pe--;)Ce[Y++]=ee}}var Re=Ce.subarray(0,$e),k=Ce.subarray($e);q=lr(Re),U=lr(k),$=Et(Re,q,1),K=Et(k,U,1)}else ue(1);else{var H=Rs(E)+4,fe=r[H-4]|r[H-3]<<8,we=H+fe;if(we>a){v&&ue(0);break}d&&b(A+fe),t.set(r.subarray(H,we),A),e.b=A+=fe,e.p=E=we*8,e.f=C;continue}if(E>x){v&&ue(0);break}}d&&b(A+131072);for(var ht=(1<<q)-1,W=(1<<U)-1,Ne=E;;Ne=E){var ee=$[fr(r,E)&ht],ve=ee>>4;if(E+=ee&15,E>x){v&&ue(0);break}if(ee||ue(2),ve<256)t[A++]=ve;else if(ve==256){Ne=E,$=null;break}else{var te=ve-254;if(ve>264){var Y=ve-257,X=Rn[Y];te=ge(r,E,(1<<X)-1)+Bn[Y],E+=X}var je=K[fr(r,E)&W],Xe=je>>4;je||ue(3),E+=je&15;var k=Ms[Xe];if(Xe>3){var X=Ln[Xe];k+=fr(r,E)&(1<<X)-1,E+=X}if(E>x){v&&ue(0);break}d&&b(A+131072);var Ct=A+te;if(A<k){var dt=n-k,Je=Math.min(k,Ct);for(dt+A<0&&ue(3);A<Je;++A)t[A]=i[dt+A]}for(;A<Ct;++A)t[A]=t[A-k]}}e.l=$,e.p=Ne,e.b=A,e.f=C,$&&(C=1,e.m=q,e.d=K,e.n=U)}while(!C);return A!=t.length&&l?Wr(t,0,A):t.subarray(0,A)},ks=new re(0),Te=function(r,e){return r[e]|r[e+1]<<8},ye=function(r,e){return(r[e]|r[e+1]<<8|r[e+2]<<16|r[e+3]<<24)>>>0},hr=function(r,e){return ye(r,e)+ye(r,e+4)*4294967296};function Bs(r,e){return Fs(r,{i:2},e&&e.out,e&&e.dictionary)}var Cr=typeof TextDecoder<"u"&&new TextDecoder,Is=0;try{Cr.decode(ks,{stream:!0}),Is=1}catch{}var Ds=function(r){for(var e="",t=0;;){var i=r[t++],a=(i>127)+(i>223)+(i>239);if(t+a>r.length)return{s:e,r:Wr(r,t-1)};a?a==3?(i=((i&15)<<18|(r[t++]&63)<<12|(r[t++]&63)<<6|r[t++]&63)-65536,e+=String.fromCharCode(55296|i>>10,56320|i&1023)):a&1?e+=String.fromCharCode((i&31)<<6|r[t++]&63):e+=String.fromCharCode((i&15)<<12|(r[t++]&63)<<6|r[t++]&63):e+=String.fromCharCode(i)}};function Os(r,e){if(e){for(var t="",i=0;i<r.length;i+=16384)t+=String.fromCharCode.apply(null,r.subarray(i,i+16384));return t}else{if(Cr)return Cr.decode(r);var a=Ds(r),n=a.s,t=a.r;return t.length&&ue(8),n}}var $s=function(r,e){return e+30+Te(r,e+26)+Te(r,e+28)},xs=function(r,e,t){var i=Te(r,e+28),a=Os(r.subarray(e+46,e+46+i),!(Te(r,e+8)&2048)),n=e+46+i,l=ye(r,e+20),d=t&&l==4294967295?Ws(r,n):[l,ye(r,e+24),ye(r,e+42)],v=d[0],b=d[1],C=d[2];return[Te(r,e+10),v,b,a,n+Te(r,e+30)+Te(r,e+32),C]},Ws=function(r,e){for(;Te(r,e)!=1;e+=4+Te(r,e+2));return[hr(r,e+12),hr(r,e+4),hr(r,e+20)]};function Ns(r,e){for(var t={},i=r.length-22;ye(r,i)!=101010256;--i)(!i||r.length-i>65558)&&ue(13);var a=Te(r,i+8);if(!a)return{};var n=ye(r,i+16),l=n==4294967295||a==65535;if(l){var d=ye(r,i-12);l=ye(r,d)==101075792,l&&(a=ye(r,d+32),n=ye(r,d+48))}for(var v=0;v<a;++v){var b=xs(r,n,l),C=b[0],E=b[1],A=b[2],$=b[3],K=b[4],q=b[5],U=$s(r,q);n=K,C?C==8?t[$]=Bs(r.subarray(U,U+E),{out:new re(A)}):ue(14,"unknown compression type "+C):t[$]=Wr(r,U,U+E)}return t}const zs=r=>{if(!Nt(r))throw new Error("Manifest must be a JSON object.");const e=zt(r.title,"title",!1),t=zt(r.version,"version",!1),i=ln(r.author,"author"),a=ln(r.description,"description");if(!Nt(r.memoryRequirements))throw new Error('Manifest field "memoryRequirements" must be an object.');const n={ram:$t(r.memoryRequirements.ram,"memoryRequirements.ram"),vram:$t(r.memoryRequirements.vram,"memoryRequirements.vram"),saveData:$t(r.memoryRequirements.saveData,"memoryRequirements.saveData")},l=Hs(r.capabilities,"capabilities"),d=Ys(r.assets);return{title:e,author:i,version:t,description:a,memoryRequirements:n,capabilities:l,assets:d}},Us=r=>{let e;try{e=JSON.parse(r)}catch(t){const i=t instanceof Error?t.message:String(t);throw new Error(`Invalid manifest.json: ${i}`)}return zs(e)},Nt=r=>typeof r=="object"&&r!==null&&!Array.isArray(r),zt=(r,e,t)=>{if(typeof r!="string")throw new Error(`Manifest field "${e}" must be a string.`);if(!t&&r.trim().length===0)throw new Error(`Manifest field "${e}" must not be empty.`);return r},ln=(r,e)=>{if(r!==void 0)return zt(r,e,!0)},$t=(r,e)=>{if(!Number.isInteger(r)||r<0)throw new Error(`Manifest field "${e}" must be a non-negative integer.`);return r},Hs=(r,e)=>{if(r!==void 0){if(!Array.isArray(r))throw new Error(`Manifest field "${e}" must be an array of strings.`);return r.forEach((t,i)=>{if(typeof t!="string")throw new Error(`Manifest field "${e}[${i}]" must be a string.`)}),r}},Ys=r=>{if(r===void 0)return;if(!Nt(r))throw new Error('Manifest field "assets" must be an object.');const e={};for(const[t,i]of Object.entries(r)){if(!Nt(i))throw new Error(`Manifest asset "${t}" must be an object.`);const a=$t(i.size,`assets.${t}.size`),n=i.type===void 0?void 0:zt(i.type,`assets.${t}.type`,!0),l=i.preload===void 0?void 0:Vs(i.preload,`assets.${t}.preload`);e[t]={size:a,type:n,preload:l}}return e},Vs=(r,e)=>{if(typeof r!="boolean")throw new Error(`Manifest field "${e}" must be a boolean.`);return r},Gs=8*1024*1024,Ks=256*1024,qs=64*1024,js=Gs+Ks+qs,Xs=64*1024*1024,Js=128*1024*1024,Dn="assets/",Zs=new TextDecoder;class Nr{constructor(e={}){u(this,"limits");const t=dr(e.baseMemoryBytes??js,"Base memory"),i=dr(e.maxRomBytes??Xs,"ROM limit"),a=dr(e.maxMemoryBytes??Js,"Total memory limit");if(t>a)throw new RangeError("Base memory cannot exceed the total memory limit.");this.limits={baseMemoryBytes:t,maxRomBytes:i,maxMemoryBytes:a}}async load(e){const t=await Nr.toUint8Array(e),i=this.unzipArchive(t),a=i["manifest.json"];if(!a){const A=Object.keys(i),$=eo(A);throw new Error(`Missing manifest.json in cartridge.${$}`)}const n=Zs.decode(a),l=Us(n),d=i["main.wasm"];if(!d)throw new Error("Missing main.wasm in cartridge.");if(d.length===0)throw new Error("main.wasm must not be empty.");const v=this.prepareAssets(l);if(console.log("CartridgeLoader.load: assetPlan.totalSize =",v.totalSize),console.log("CartridgeLoader.load: number of assets =",v.entries.length),v.totalSize>this.limits.maxRomBytes)throw new Error(`Total asset size ${v.totalSize} exceeds ROM limit of ${this.limits.maxRomBytes} bytes.`);const b=this.limits.baseMemoryBytes+v.totalSize;if(console.log("CartridgeLoader.load: totalMemoryBytes = 0x"+b.toString(16)),b>this.limits.maxMemoryBytes)throw new Error(`Total cartridge memory ${b} exceeds limit of ${this.limits.maxMemoryBytes} bytes.`);const C=this.loadAssets(i,v.entries),E=i["palette.pal"];return console.log("CartridgeLoader.load: returning CartridgeLoadResult with totalAssetSize =",v.totalSize),{manifest:l,wasm:d,assets:C,totalAssetSize:v.totalSize,totalMemoryBytes:b,palette:E}}unzipArchive(e){try{return Ns(e)}catch(t){const i=t instanceof Error?t.message:String(t);throw new Error(`Failed to read .gac archive: ${i}`)}}prepareAssets(e){const t=e.assets??{},i=[];let a=0;for(const[n,l]of Object.entries(t))Qs(n),i.push({name:n,info:l}),a+=l.size;if(a>Number.MAX_SAFE_INTEGER)throw new Error("Total asset size exceeds safe integer limit.");return{entries:i,totalSize:a}}loadAssets(e,t){const i=new Map;for(const{name:a,info:n}of t){const l=`${Dn}${a}`,d=e[l];if(!d)throw new Error(`Missing asset "${a}" at "${l}".`);if(d.length!==n.size)throw new Error(`Asset "${a}" size mismatch: manifest ${n.size} bytes, actual ${d.length} bytes.`);i.set(a,{name:a,bytes:d,size:d.length,preload:n.preload??!1,type:n.type})}return i}static async toUint8Array(e){if(e instanceof Uint8Array)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(typeof Blob<"u"&&e instanceof Blob){const t=await e.arrayBuffer();return new Uint8Array(t)}throw new Error("Unsupported cartridge source.")}}const dr=(r,e)=>{if(!Number.isInteger(r)||r<0)throw new RangeError(`${e} must be a non-negative integer.`);return r},Qs=r=>{if(r.trim().length===0)throw new Error("Manifest asset names must not be empty.");if(r.startsWith(Dn))throw new Error(`Manifest asset name "${r}" must omit the "assets/" prefix.`);if(r.startsWith("/")||r.includes("\\"))throw new Error(`Manifest asset name "${r}" must use forward slashes only.`);if(r.includes("\0"))throw new Error(`Manifest asset name "${r}" contains invalid characters.`);const e=r.split("/");if(e.some(t=>t.length===0))throw new Error(`Manifest asset name "${r}" must not include empty path segments.`);if(e.some(t=>t==="."||t===".."))throw new Error(`Manifest asset name "${r}" must not contain "." or ".." segments.`)},eo=r=>{if(r.length===0)return"";const e=10,t=r.slice(0,e).join(", "),i=r.length>e?", ...":"";return` Found ${r.length} entries: ${t}${i}.`},Q=class Q{constructor(e=0){u(this,"tick");this.tick=Q.normalizeTick(e)}getTick(){return this.tick}setTick(e){this.tick=Q.normalizeTick(e)}advance(e=1){if(!Number.isInteger(e)||e<0)throw new RangeError("Tick increment must be a non-negative integer.");return e===0?this.tick:(this.tick=Q.wrapUint32(this.tick+e),this.tick)}reset(){this.tick=0}ticksToMs(e=this.tick){return Q.ticksToMs(e)}ticksToSeconds(e=this.tick){return Q.ticksToSeconds(e)}static ticksToMs(e){const t=Q.normalizeTick(e);return Math.floor(t*1e3/Q.TICK_RATE)}static ticksToSeconds(e){return Q.normalizeTick(e)/Q.TICK_RATE}static normalizeTick(e){if(!Number.isInteger(e)||e<0)throw new RangeError("Tick value must be a non-negative integer.");return Q.wrapUint32(e)}static wrapUint32(e){return e>>>0}};u(Q,"TICK_RATE",35),u(Q,"MS_PER_TICK",1e3/Q.TICK_RATE);let Ut=Q;class to{constructor(e){u(this,"accumulator",0);u(this,"lastTime",performance.now());u(this,"msPerTick",Ut.MS_PER_TICK);u(this,"maxCatchUpTicks",4);this.tickCounter=e}update(){const e=performance.now(),t=e-this.lastTime;this.lastTime=e,this.accumulator+=t;let i=0;for(;this.accumulator>=this.msPerTick&&i<this.maxCatchUpTicks;)i+=1,this.accumulator-=this.msPerTick;return i>=this.maxCatchUpTicks&&(this.accumulator=0),i}getTickCounter(){return this.tickCounter}}const T=class T{constructor(e){u(this,"totalAssetBytes");u(this,"totalBytes");u(this,"pages");u(this,"memory");console.log("MemoryManager constructor: totalAssetBytes =",e);const t=T.normalizeAssetBytes(e);console.log("MemoryManager constructor: normalizedAssets =",t);const i=T.BASE_MEMORY_BYTES+t;console.log("MemoryManager constructor: BASE_MEMORY_BYTES = 0x"+T.BASE_MEMORY_BYTES.toString(16)),console.log("MemoryManager constructor: totalBytes = 0x"+i.toString(16));const a=T.calculatePages(i);console.log("MemoryManager constructor: pages =",a),this.totalAssetBytes=t,this.totalBytes=i,this.pages=a,console.log("MemoryManager constructor: creating WebAssembly.Memory with initial="+a),this.memory=new WebAssembly.Memory({initial:a,maximum:T.MAX_PAGES}),console.log("MemoryManager constructor: memory created, buffer size =",this.memory.buffer.byteLength)}static fromCartridge(e){return T.validateManifest(e.manifest),new T(e.totalAssetSize)}static calculateTotalBytes(e){return T.BASE_MEMORY_BYTES+T.normalizeAssetBytes(e)}static calculatePages(e){const t=fn(e,"Total bytes"),i=Math.ceil(t/T.PAGE_BYTES);if(i>T.MAX_PAGES)throw new RangeError(`Total memory pages ${i} exceeds maximum of ${T.MAX_PAGES}.`);return i}static validateManifest(e){const{ram:t,vram:i,saveData:a}=e.memoryRequirements;if(t>T.RAM_BYTES)throw new RangeError(`Manifest RAM requirement ${t} exceeds runtime RAM size of ${T.RAM_BYTES} bytes.`);if(i>T.VRAM_BYTES)throw new RangeError(`Manifest VRAM requirement ${i} exceeds runtime VRAM size of ${T.VRAM_BYTES} bytes.`);if(a>T.SAVE_BYTES)throw new RangeError(`Manifest save data requirement ${a} exceeds runtime save data size of ${T.SAVE_BYTES} bytes.`)}getRegion(e){switch(e){case"ram":return T.createRegion(T.RAM_OFFSET,T.RAM_BYTES);case"vram":return T.createRegion(T.VRAM_OFFSET,T.VRAM_BYTES);case"save":return T.createRegion(T.SAVE_OFFSET,T.SAVE_BYTES);case"rom":return T.createRegion(T.ROM_OFFSET,this.totalAssetBytes)}}getVramView(){return this.createView(T.VRAM_OFFSET,T.VRAM_BYTES)}getRomView(){return this.createView(T.ROM_OFFSET,this.totalAssetBytes)}createView(e,t){return new Uint8Array(this.memory.buffer,e,t)}static createRegion(e,t){return{offset:e,length:t,end:e+t}}static normalizeAssetBytes(e){const t=fn(e,"Total asset bytes");if(t>T.ROM_MAX_BYTES)throw new RangeError(`Total asset bytes ${t} exceeds ROM limit of ${T.ROM_MAX_BYTES} bytes.`);return t}};u(T,"PAGE_BYTES",65536),u(T,"MAX_PAGES",2048),u(T,"RAM_OFFSET",0),u(T,"RAM_BYTES",8388608),u(T,"VRAM_OFFSET",T.RAM_OFFSET+T.RAM_BYTES),u(T,"VRAM_BYTES",262144),u(T,"SAVE_OFFSET",T.VRAM_OFFSET+T.VRAM_BYTES),u(T,"SAVE_BYTES",65536),u(T,"ROM_OFFSET",T.SAVE_OFFSET+T.SAVE_BYTES),u(T,"ROM_MAX_BYTES",67108864),u(T,"BASE_MEMORY_BYTES",T.ROM_OFFSET);let _e=T;const fn=(r,e)=>{if(!Number.isInteger(r)||r<0)throw new RangeError(`${e} must be a non-negative integer.`);return r},ot=class ot{constructor(e,t){u(this,"lookup",new Map);this.memory=e;const i=t.manifest.assets??{},a=ro(t.totalAssetSize),n=no(i);if(n!==a)throw new Error(`Manifest asset total ${n} does not match cartridge total asset size ${a}.`);io(e,a);for(const v of t.assets.keys())if(!(v in i))throw new Error(`Asset "${v}" is not declared in manifest.`);const l=new Uint8Array(e.buffer,ot.ROM_OFFSET,a);let d=0;for(const[v,b]of Object.entries(i)){const C=t.assets.get(v);if(!C)throw new Error(`Missing asset "${v}" referenced by manifest.`);const E=C.bytes.length;if(E!==b.size)throw new Error(`Asset "${v}" size mismatch: manifest ${b.size} bytes, actual ${E} bytes.`);l.set(C.bytes,d),this.lookup.set(v.toLowerCase(),{offset:ot.ROM_OFFSET+d,size:E}),d+=E}if(d!==a)throw new Error(`Loaded asset total ${d} does not match expected ${a}.`)}getAssetDataPointer(e){var t;return((t=this.lookup.get(e.toLowerCase()))==null?void 0:t.offset)??0}getAssetSize(e){var t;return((t=this.lookup.get(e.toLowerCase()))==null?void 0:t.size)??0}};u(ot,"ROM_OFFSET",_e.ROM_OFFSET),u(ot,"ROM_MAX_BYTES",_e.ROM_MAX_BYTES);let at=ot;const ro=r=>{if(!Number.isInteger(r)||r<0)throw new RangeError("Total asset bytes must be a non-negative integer.");if(r>at.ROM_MAX_BYTES)throw new RangeError(`Total asset bytes ${r} exceeds ROM limit of ${at.ROM_MAX_BYTES} bytes.`);return r},no=r=>{let e=0;for(const t of Object.values(r))e+=t.size;return e},io=(r,e)=>{const t=at.ROM_OFFSET+e;if(r.buffer.byteLength<t)throw new RangeError(`WASM memory ${r.buffer.byteLength} bytes cannot fit ROM assets (${t} bytes required).`)},F=class F{constructor(e){u(this,"memory");u(this,"buffer");u(this,"view");console.log("Framebuffer constructor: memory.buffer.byteLength =",e.buffer.byteLength),console.log("Framebuffer constructor: VRAM_OFFSET = 0x"+F.VRAM_OFFSET.toString(16)),console.log("Framebuffer constructor: BYTE_LENGTH =",F.BYTE_LENGTH),console.log("Framebuffer constructor: needed end address = 0x"+(F.VRAM_OFFSET+F.BYTE_LENGTH).toString(16)),this.memory=e,this.buffer=e.buffer,this.view=F.createView(this.buffer),console.log("Framebuffer constructor: SUCCESS")}getBytes(){return this.buffer!==this.memory.buffer&&(this.buffer=this.memory.buffer,this.view=F.createView(this.buffer)),this.view}getPointer(){return F.VRAM_OFFSET}getLength(){return F.BYTE_LENGTH}static createView(e){return F.assertWithinVram(),F.assertBufferLength(e.byteLength),new Uint8Array(e,F.VRAM_OFFSET,F.BYTE_LENGTH)}static assertWithinVram(){const e=F.VRAM_OFFSET+F.BYTE_LENGTH,t=F.VRAM_OFFSET+F.VRAM_BYTES;if(e>t)throw new RangeError(`Framebuffer length ${F.BYTE_LENGTH} exceeds VRAM region of ${F.VRAM_BYTES} bytes.`)}static assertBufferLength(e){const t=F.VRAM_OFFSET+F.BYTE_LENGTH;if(e<t)throw new RangeError(`Framebuffer requires memory up to ${t} bytes, got ${e} bytes.`)}};u(F,"WIDTH",320),u(F,"HEIGHT",240),u(F,"BYTE_LENGTH",F.WIDTH*F.HEIGHT),u(F,"VRAM_OFFSET",8388608),u(F,"VRAM_BYTES",262144);let le=F;const st=256,bt=st*3,hn=st*4,mr=255,dn=[0,0,0,0,0,170,0,170,0,0,170,170,170,0,0,170,0,170,170,85,0,170,170,170,85,85,85,85,85,255,85,255,85,85,255,255,255,85,85,255,85,255,255,255,85,255,255,255],gr=[0,51,102,153,204,255],so=8,oo=10,ao=24,co=()=>{const r=new Uint8Array(bt);r.set(dn,0);let e=dn.length;for(const t of gr)for(const i of gr)for(const a of gr)r[e]=t,r[e+1]=i,r[e+2]=a,e+=3;for(let t=0;t<ao;t+=1){const i=so+oo*t;r[e]=i,r[e+1]=i,r[e+2]=i,e+=3}return r},uo=co(),oe=class oe{constructor(e){u(this,"rgb");u(this,"rgba");u(this,"rgba32");this.rgb=new Uint8Array(bt),this.rgba=new Uint8Array(hn),this.rgba32=new Uint32Array(st),this.loadPalette(e)}loadPalette(e){this.applyPaletteBytes(uo),e&&this.applyPaletteBytes(e)}setPalette(e,t,i,a){const n=oe.normalizeIndex(e),l=oe.normalizeChannel(t,"Red"),d=oe.normalizeChannel(i,"Green"),v=oe.normalizeChannel(a,"Blue");this.writeEntry(n,l,d,v)}getColor(e){const i=oe.normalizeIndex(e)*3;return{r:this.rgb[i],g:this.rgb[i+1],b:this.rgb[i+2]}}getRgbBytes(){return this.rgb}getRgbaBytes(){return this.rgba}getRgba32(){return this.rgba32}applyPaletteBytes(e){if(e.length!==bt)throw new Error(`Palette data must be ${bt} bytes (RGB888 per entry).`);for(let t=0;t<st;t+=1){const i=t*3;this.writeEntry(t,e[i],e[i+1],e[i+2])}}writeEntry(e,t,i,a){const n=e*3;this.rgb[n]=t,this.rgb[n+1]=i,this.rgb[n+2]=a;const l=e*4;this.rgba[l]=t,this.rgba[l+1]=i,this.rgba[l+2]=a,this.rgba[l+3]=mr,this.rgba32[e]=oe.packRgba32(t,i,a,mr)}static packRgba32(e,t,i,a){return(e<<24|t<<16|i<<8|a)>>>0}static normalizeIndex(e){if(!Number.isInteger(e)||e<0||e>=st)throw new RangeError("Palette index must be an integer between 0 and 255.");return e}static normalizeChannel(e,t){if(!Number.isInteger(e)||e<0||e>255)throw new RangeError(`${t} channel must be an integer between 0 and 255.`);return e}};u(oe,"COLOR_COUNT",st),u(oe,"RGB_BYTES",bt),u(oe,"RGBA_BYTES",hn),u(oe,"DEFAULT_ALPHA",mr);let Ht=oe;class lo{constructor(e,t){u(this,"heapPointer");u(this,"heapStart");u(this,"heapEnd");this.heapStart=e,this.heapEnd=t,this.heapPointer=e}malloc(e){if(e<=0||!Number.isInteger(e))return 0;const t=this.alignUp(e,8),i=this.heapPointer+t;if(i>this.heapEnd)return 0;const a=this.heapPointer;return this.heapPointer=i,a}free(e){}realloc(e,t){return t<=0||!Number.isInteger(t)?0:this.malloc(t)}getHeapPointer(){return this.heapPointer}reset(){this.heapPointer=this.heapStart}alignUp(e,t){return e+(t-1)&~(t-1)}}class Z{static memset(e,t,i,a){if(e<0||i<0||e+i>a.byteLength)return 0;const n=t&255,l=new Uint8Array(a);for(let d=0;d<i;d++)l[e+d]=n;return e}static memcpy(e,t,i,a){if(e<0||t<0||i<0||e+i>a.byteLength||t+i>a.byteLength)return 0;const n=new Uint8Array(a);if(t<e&&t+i>e)for(let l=i-1;l>=0;l--)n[e+l]=n[t+l];else for(let l=0;l<i;l++)n[e+l]=n[t+l];return e}static memmove(e,t,i,a){return this.memcpy(e,t,i,a)}static strlen(e,t,i=65536){if(e<0||e>=t.byteLength)return 0;const a=new Uint8Array(t);let n=0;for(;n<i&&e+n<t.byteLength&&a[e+n]!==0;)n++;return n}static strcpy(e,t,i){if(e<0||t<0)return 0;const a=new Uint8Array(i);let n=0;for(;t+n<i.byteLength&&a[t+n]!==0;){if(e+n>=i.byteLength)return 0;a[e+n]=a[t+n],n++}return e+n>=i.byteLength?0:(a[e+n]=0,e)}static strncpy(e,t,i,a){if(e<0||t<0||i<0||e+i>a.byteLength||t+i>a.byteLength)return 0;const n=new Uint8Array(a);let l=0;for(;l<i&&n[t+l]!==0;)n[e+l]=n[t+l],l++;for(;l<i;)n[e+l]=0,l++;return e}static strcmp(e,t,i){if(e<0||t<0)return 0;const a=new Uint8Array(i);let n=0;for(;e+n<i.byteLength&&t+n<i.byteLength;){const l=a[e+n],d=a[t+n];if(l===0&&d===0)return 0;if(l!==d)return l<d?-1:1;n++}return 0}static strncmp(e,t,i,a){if(e<0||t<0||i<0)return 0;const n=new Uint8Array(a);for(let l=0;l<i;l++){if(e+l>=a.byteLength||t+l>=a.byteLength)return 0;const d=n[e+l],v=n[t+l];if(d===0&&v===0)return 0;if(d!==v)return d<v?-1:1}return 0}static strcat(e,t,i){if(e<0||t<0)return 0;const a=new Uint8Array(i);let n=e;for(;n<i.byteLength&&a[n]!==0;)n++;if(n>=i.byteLength)return 0;let l=0;for(;n+l<i.byteLength&&a[t+l]!==0;)a[n+l]=a[t+l],l++;return n+l>=i.byteLength?0:(a[n+l]=0,e)}static abs(e){return Math.abs(e|0)}static sqrt(e){return Math.sqrt(e)}static sin(e){return Math.sin(e)}static cos(e){return Math.cos(e)}static tan(e){return Math.tan(e)}static atan2(e,t){return Math.atan2(e,t)}}const I=class I{constructor(e){u(this,"memory");u(this,"framebuffer");u(this,"palette");u(this,"display");u(this,"input");u(this,"audio");u(this,"timing");u(this,"rng");u(this,"assets");u(this,"storage");u(this,"decoder",new TextDecoder("utf-8"));u(this,"allocator");u(this,"timingStartMs",0);u(this,"timingInitialized",!1);this.memory=e.memory,this.framebuffer=e.framebuffer,this.palette=e.palette,this.display=e.display,this.input=e.input,this.audio=e.audio,this.timing=e.timing,this.rng=e.rng,this.assets=e.assets,this.storage=e.storage,this.allocator=new lo(I.HEAP_START,I.HEAP_END)}getImports(){return{get_framebuffer:()=>S(()=>this.framebuffer.getPointer(),0),set_palette:(e,t,i,a)=>{Me(()=>this.palette.setPalette(e,t,i,a))},flip:()=>{Me(()=>this.display.flip())},is_key_down:e=>S(()=>{this.ensureInputSnapshot();const t=this.input.isKeyDown(fo(e));return mn(t)},0),get_mouse_delta:(e,t)=>{Me(()=>{this.ensureInputSnapshot();const i=this.input.getMouseDelta();yn(this.memory,e,i.x),yn(this.memory,t,i.y)})},is_mouse_button_down:e=>S(()=>(this.ensureInputSnapshot(),Number.isInteger(e)?mn(this.input.isMouseButtonDown(e)):0),0),play_sound:(e,t,i)=>S(()=>{const a=Ot(t);if(a<=0)return-1;const n=gn(i),l=pr(this.memory,e,a);if(!l)return-1;const d=new Uint8Array(a);return d.set(l),this.audio.playSound(d,a,n)},-1),stop_sound:e=>{Me(()=>this.handleStopSound(e))},opl2_write:(e,t)=>{Me(()=>this.handleOpl2Write(e,t))},get_tick:()=>S(()=>this.getWallClockTick(),0),get_ticks_ms:()=>S(()=>this.getWallClockMs(),0),get_active_channels:()=>S(()=>{var e,t;return((t=(e=this.audio).getActiveChannelCount)==null?void 0:t.call(e))??0},0),rand_seed:e=>{Me(()=>this.rng.randSeed(e))},rand_u32:()=>S(()=>this.rng.randU32(),0),rand_range:e=>S(()=>this.rng.randRange(e),0),rand_float:()=>S(()=>this.rng.randFloat(),0),get_asset_data:e=>S(()=>this.handleGetAssetData(e),0),get_asset_size:e=>S(()=>this.handleGetAssetSize(e),0),save_data:(e,t)=>{Me(()=>this.handleSaveData(e,t))},load_data:(e,t)=>S(()=>this.handleLoadData(e,t),0),malloc:e=>S(()=>{const t=this.allocator.malloc(e);return t===0&&console.error("[malloc FAILED] size:",e,"heap full"),t},0),free:e=>Me(()=>this.allocator.free(e)),realloc:(e,t)=>S(()=>{const i=this.allocator.realloc(e,t);return i===0&&console.error("[realloc FAILED] ptr:",e,"size:",t),i},0),memset:(e,t,i)=>S(()=>Z.memset(e,t,i,this.memory.buffer),0),memcpy:(e,t,i)=>S(()=>Z.memcpy(e,t,i,this.memory.buffer),0),memmove:(e,t,i)=>S(()=>Z.memmove(e,t,i,this.memory.buffer),0),strlen:e=>S(()=>Z.strlen(e,this.memory.buffer),0),strcpy:(e,t)=>S(()=>Z.strcpy(e,t,this.memory.buffer),0),strncpy:(e,t,i)=>S(()=>Z.strncpy(e,t,i,this.memory.buffer),0),strcmp:(e,t)=>S(()=>Z.strcmp(e,t,this.memory.buffer),0),strncmp:(e,t,i)=>S(()=>Z.strncmp(e,t,i,this.memory.buffer),0),strcat:(e,t)=>S(()=>Z.strcat(e,t,this.memory.buffer),0),abs:e=>S(()=>Z.abs(e),0),sqrt:e=>S(()=>Z.sqrt(e),0),sin:e=>S(()=>Z.sin(e),0),cos:e=>S(()=>Z.cos(e),0),tan:e=>S(()=>Z.tan(e),0),atan2:(e,t)=>S(()=>Z.atan2(e,t),0),ftell:e=>S(()=>-1,-1),fseek:(e,t,i)=>S(()=>-1,-1),fgets:(e,t,i)=>S(()=>0,0),fgetc:e=>S(()=>-1,-1),fputc:(e,t)=>S(()=>-1,-1),fclose:e=>S(()=>-1,-1),fopen:(e,t)=>S(()=>0,0),fread:(e,t,i,a)=>S(()=>0,0),fwrite:(e,t,i,a)=>S(()=>0,0),fflush:e=>S(()=>0,0),printf:(e,...t)=>S(()=>{const i=pe(this.memory,this.decoder,e,I.MAX_STRING_BYTES);if(i){const a=wn(this.memory,this.decoder,i,t,I.MAX_STRING_BYTES);return console.log("[WASM printf]",a),a.length}return 0},0),fprintf:(e,t,...i)=>S(()=>{const a=pe(this.memory,this.decoder,t,I.MAX_STRING_BYTES);if(a){const n=wn(this.memory,this.decoder,a,i,I.MAX_STRING_BYTES);return e===2?console.error("[WASM stderr]",n):console.log("[WASM fprintf]",n),n.length}return 0},0),puts:e=>S(()=>{const t=pe(this.memory,this.decoder,e,I.MAX_STRING_BYTES);return t&&console.log("[WASM puts]",t),t?t.length:-1},-1),putchar:e=>S(()=>(console.log("[WASM putchar]",String.fromCharCode(e)),e),-1),vprintf:(e,t)=>S(()=>{const i=pe(this.memory,this.decoder,e,I.MAX_STRING_BYTES);return i&&console.log("[WASM vprintf]",i),i?i.length:0},0),vfprintf:(e,t,i)=>S(()=>{console.log("[vfprintf CALLED] filePtr:",e,"formatPtr:",t.toString(16));const a=pe(this.memory,this.decoder,t,I.MAX_STRING_BYTES);return console.log("[vfprintf] format string:",a),a&&(e===2?(console.error("========================================"),console.error("[DOOM FATAL ERROR]",a),console.error("========================================"),console.log("[DOOM FATAL ERROR]",a)):console.log("[WASM vfprintf]",a)),a?a.length:0},0),exit:e=>{throw new Error(`WASM called exit(${e})`)},abort:()=>{throw new Error("WASM called abort()")},__builtin_trap:()=>{throw new Error("WASM called __builtin_trap() - fatal error occurred")},snprintf:(e,t,i,...a)=>S(()=>{const n=pe(this.memory,this.decoder,i,I.MAX_STRING_BYTES);if(n&&e&&t>0){const l=new TextEncoder().encode(n.substring(0,t-1)+"\0");return yr(this.memory,e,l),l.length-1}return 0},0),vsnprintf:(e,t,i,a)=>S(()=>{const n=pe(this.memory,this.decoder,i,I.MAX_STRING_BYTES);if(n&&e&&t>0){const l=new TextEncoder().encode(n.substring(0,t-1)+"\0");return yr(this.memory,e,l),l.length-1}return 0},0),platform_print:e=>Me(()=>{console.log("[platform_print CALLED] strPtr:",e.toString(16));const t=pe(this.memory,this.decoder,e,I.MAX_STRING_BYTES);console.log("[platform_print] string read:",t?`"${t}"`:"null"),t?console.log("[DOOM]",t):console.error("[platform_print] Failed to read string at",e.toString(16))})}}createImportObject(){const e=this.getImports(),t=new Proxy(e,{get:(i,a)=>{const n=String(a);if(n in i)return i[n];if(console.log("[HostAPI] Missing import requested:",n),n.startsWith("I_")||n.startsWith("W_")||n.startsWith("W_")||n.startsWith("M_")||n.startsWith("S_")||n.startsWith("P_")||n.startsWith("D_")||n.startsWith("DEH_"))return console.log("[HostAPI] Providing stub for game function:",n),()=>0}});return{[I.MODULE_NAME]:{memory:this.memory,...t}}}getWallClockMs(){return this.timingInitialized||(this.timingStartMs=performance.now(),this.timingInitialized=!0),Math.floor(performance.now()-this.timingStartMs)}getWallClockTick(){const e=this.getWallClockMs();return Math.floor(e*35/1e3)}ensureInputSnapshot(){const e=this.getWallClockTick();this.input.snapshot(e)}handlePlaySound(e,t,i){const a=Ot(t);if(a<=0)return-1;const n=gn(i),l=pr(this.memory,e,a);if(!l)return-1;const d=new Uint8Array(l.length);return d.set(l),this.audio.playSound(d,a,n)}handleStopSound(e){!Number.isInteger(e)||e<0||e>=I.AUDIO_CHANNELS||this.audio.stopSound(e)}handleOpl2Write(e,t){const i=pn(e),a=pn(t);if(this.audio.queueOpl2Write){this.audio.queueOpl2Write(i,a);return}this.audio.opl2Write(i,a)}handleGetAssetData(e){const t=pe(this.memory,this.decoder,e,I.MAX_STRING_BYTES);return t?this.assets.getAssetDataPointer(t):0}handleGetAssetSize(e){const t=pe(this.memory,this.decoder,e,I.MAX_STRING_BYTES);return t?this.assets.getAssetSize(t):0}handleSaveData(e,t){const i=Ot(t);if(i<=0)return;const a=Math.min(i,I.SAVE_MAX_BYTES),n=pr(this.memory,e,a);if(!n)return;const l=new Uint8Array(n.length);l.set(n),this.storage.save(l)}handleLoadData(e,t){const i=Ot(t);if(i<=0)return 0;const a=Math.min(i,I.SAVE_MAX_BYTES),n=this.storage.load(a);if(!n||n.length===0)return 0;const l=Math.min(n.length,a);return yr(this.memory,e,n.subarray(0,l))?l:0}};u(I,"MODULE_NAME","env"),u(I,"AUDIO_CHANNELS",16),u(I,"SAVE_MAX_BYTES",65536),u(I,"MAX_STRING_BYTES",1024),u(I,"HEAP_START",1048576),u(I,"HEAP_END",8388608);let Pr=I;const S=(r,e)=>{try{return r()}catch{return e}},Me=r=>{try{r()}catch{return}},mn=r=>r?1:0,fo=r=>!Number.isInteger(r)||r<0||r>255?-1:r,Ot=r=>{if(!Number.isFinite(r))return-1;const e=Math.trunc(r);return e<0?-1:e},gn=r=>!Number.isFinite(r)||r<=0?0:r>=1?1:r,pn=r=>{if(!Number.isFinite(r))return 0;const e=Math.trunc(r);return e<0?0:e>255?255:e},pr=(r,e,t)=>{const i=r.buffer;return Gt(e,t,i.byteLength)?new Uint8Array(i,e,t):null},yr=(r,e,t)=>{const i=r.buffer;return Gt(e,t.length,i.byteLength)?(new Uint8Array(i,e,t.length).set(t),!0):!1},yn=(r,e,t)=>{const i=r.buffer;if(!Gt(e,4,i.byteLength))return;new DataView(i).setInt32(e,Math.trunc(t),!0)},pe=(r,e,t,i)=>{const a=r.buffer;if(!Gt(t,1,a.byteLength))return null;const n=Math.min(a.byteLength,t+i),l=new Uint8Array(a);let d=t;for(;d<n&&l[d]!==0;d+=1);return d===n?null:e.decode(l.subarray(t,d))},wn=(r,e,t,i,a)=>{let n="",l=0,d=0;for(;d<t.length;){if(t[d]!=="%"){n+=t[d],d++;continue}if(d++,d>=t.length){n+="%";break}for(;d<t.length&&"-+ #0".includes(t[d]);)d++;for(;d<t.length&&t[d]>="0"&&t[d]<="9";)d++;if(d<t.length&&t[d]===".")for(d++;d<t.length&&t[d]>="0"&&t[d]<="9";)d++;for(;d<t.length&&"hlLzjt".includes(t[d]);)d++;if(d>=t.length)break;const v=t[d];switch(d++,v){case"%":n+="%";break;case"s":{const b=i[l++]??0,C=pe(r,e,b,a);n+=C??"(null)";break}case"d":case"i":{const b=i[l++]??0;n+=(b|0).toString(10);break}case"u":{const b=i[l++]??0;n+=(b>>>0).toString(10);break}case"x":{const b=i[l++]??0;n+=(b>>>0).toString(16);break}case"X":{const b=i[l++]??0;n+=(b>>>0).toString(16).toUpperCase();break}case"p":{const b=i[l++]??0;n+="0x"+(b>>>0).toString(16);break}case"c":{const b=i[l++]??0;n+=String.fromCharCode(b&255);break}default:n+="%"+v,l++}}return n},Gt=(r,e,t)=>!(!Number.isInteger(r)||!Number.isInteger(e)||r<0||e<0||r>t-e);class ho{constructor(e){u(this,"createDisplay");u(this,"input");u(this,"audio");u(this,"timing");u(this,"rng");u(this,"storage");u(this,"createMemoryManager");u(this,"createFramebuffer");u(this,"createPalette");u(this,"createAssetManager");u(this,"createHostAPIBridge");u(this,"compileWasm");u(this,"instantiateWasm");u(this,"runtime",null);u(this,"bridge",null);u(this,"initCalled",!1);this.createDisplay=e.createDisplay,this.input=e.input,this.audio=e.audio,this.timing=e.timing,this.rng=e.rng,this.storage=e.storage,this.createMemoryManager=e.createMemoryManager??(t=>_e.fromCartridge(t)),this.createFramebuffer=e.createFramebuffer??(t=>new le(t)),this.createPalette=e.createPalette??(()=>new Ht),this.createAssetManager=e.createAssetManager??((t,i)=>new at(t,i)),this.createHostAPIBridge=e.createHostAPIBridge??(t=>new Pr(t)),this.compileWasm=e.compileWasm??(t=>WebAssembly.compile(t)),this.instantiateWasm=e.instantiateWasm??((t,i)=>WebAssembly.instantiate(t,i))}static calculateMemoryPlan(e){const t=_e.calculateTotalBytes(e),i=_e.calculatePages(t);return{totalAssetBytes:e,totalBytes:t,pages:i}}static calculatePagesForBytes(e){return _e.calculatePages(e)}async loadCartridge(e){const t=this.createMemoryManager({manifest:e.manifest,totalAssetSize:e.totalAssetSize}),i=t.memory,a=this.createFramebuffer(i),n=this.createPalette(),l=this.createDisplay(a,n),d=new mo,v=typeof this.storage=="function"?this.storage(e.manifest.title):this.storage,b=this.createHostAPIBridge({memory:i,framebuffer:a,palette:n,display:l,input:this.input,audio:this.audio,timing:this.timing,rng:this.rng,assets:d.asAssetManager(),storage:v}),C=await this.compileWasm(e.wasm),E=await this.instantiateWasm(C,b.createImportObject()),A=vn(E,"init"),$=vn(E,"update"),K=this.createAssetManager(i,e);d.setAssets(K),this.initCalled=!1;const q={memoryManager:t,memory:i,instance:E,assets:K,framebuffer:a,palette:n,display:l,init:()=>{if(this.initCalled)throw new Error("WASM init() has already been called.");A(),this.initCalled=!0},update:()=>{if(!this.initCalled)throw new Error("WASM init() must be called before update().");$()}};return this.runtime=q,this.bridge=b,q}init(){if(!this.runtime)throw new Error("No WASM runtime loaded.");this.runtime.init()}update(){var e,t;if(!this.runtime)throw new Error("No WASM runtime loaded.");(t=(e=this.bridge)==null?void 0:e.prepareFrame)==null||t.call(e),this.runtime.update()}getRuntime(){return this.runtime}}class mo{constructor(){u(this,"assets",null)}setAssets(e){this.assets=e}getAssetDataPointer(e){var t;return((t=this.assets)==null?void 0:t.getAssetDataPointer(e))??0}getAssetSize(e){var t;return((t=this.assets)==null?void 0:t.getAssetSize(e))??0}asAssetManager(){return this}}const vn=(r,e)=>{const t=r.exports[e];if(t===void 0)throw new Error(`Missing required WASM export "${e}".`);if(typeof t!="function")throw new Error(`WASM export "${e}" must be a function.`);return t};class go{constructor(e,t,i,a,n,l,d,v){u(this,"state","idle");u(this,"runtime",null);u(this,"runtimeManager",null);u(this,"initCalled",!1);u(this,"rafId",null);u(this,"tickCounter");u(this,"requestFrame");u(this,"cancelFrame");u(this,"runFrame",()=>{if(this.rafId=null,this.state!=="running"&&this.state!=="paused")return;if(!this.runtime){this.state="idle";return}if(!this.safetyMonitor.isRunning()){this.enterErrorState();return}const e=this.timing.update(),t=this.input.isPaused();if(t?this.state!=="paused"&&(this.state="paused"):this.state==="paused"&&(this.state="running"),!t)for(let i=0;i<e;i+=1){if(!this.safetyMonitor.isRunning()){this.enterErrorState();break}this.tickCounter.advance();const a=this.tickCounter.getTick();if(this.input.snapshot(a),!this.safetyMonitor.runFrame(()=>{var l;(l=this.runtimeManager)==null||l.update()}).ok){this.enterErrorState();break}}this.runtime.display.present(),(this.state==="running"||this.state==="paused")&&this.scheduleNextFrame()});this.display=e,this.input=t,this.timing=i,this.safetyMonitor=a,this.rng=n,this.storage=l,this.audio=d,this.canvas=v,this.tickCounter=i.getTickCounter(),this.requestFrame=typeof requestAnimationFrame=="function"?requestAnimationFrame.bind(typeof window<"u"?window:globalThis):b=>{const C=typeof performance<"u"?performance.now():Date.now();return setTimeout(()=>b(C),1e3/60)},this.cancelFrame=b=>{if(typeof cancelAnimationFrame=="function"&&typeof b=="number"){cancelAnimationFrame.call(typeof window<"u"?window:globalThis,b);return}clearTimeout(b)}}async loadCartridge(e){this.cancelLoop(),this.state="loading",this.initCalled=!1,this.runtime=null,this.runtimeManager=null;try{const i=await new Nr().load(e),a=new ho({createDisplay:(l,d)=>(this.display.setFramebuffer(l),this.display.setPalette(d),this.display),input:this.input,audio:this.audio,timing:this.tickCounter,rng:this.rng,storage:this.storage}),n=await a.loadCartridge(i);i.palette&&n.palette.loadPalette(i.palette),this.tickCounter.reset(),this.safetyMonitor.reset(),this.runtimeManager=a,this.runtime=n,this.state="idle"}catch(t){throw this.state="error",this.runtime=null,this.runtimeManager=null,t}}start(){if(!this.runtime)throw new Error("No cartridge loaded.");if(this.state==="loading")throw new Error("Cartridge is still loading.");if(!(this.state==="running"||this.state==="paused")){if(this.state==="error")throw new Error("Runtime is in an error state.");if(!this.initCalled)try{console.log("Calling runtime.init()..."),this.tickCounter.advance(),this.runtime.init(),console.log("runtime.init() completed successfully"),this.initCalled=!0}catch(e){throw console.error("runtime.init() failed with error:",e),e instanceof Error&&(console.error("Error message:",e.message),console.error("Error stack:",e.stack)),e}this.audio.start().catch(e=>{console.error("Failed to start audio engine:",e)}),this.input.setPaused(!1),this.state=this.input.isPaused()?"paused":"running",this.scheduleNextFrame()}}stop(){this.cancelLoop(),this.state!=="error"&&(this.state="idle")}getState(){return this.state}scheduleNextFrame(){this.rafId===null&&(this.rafId=this.requestFrame(this.runFrame))}enterErrorState(){this.state="error",this.cancelLoop()}cancelLoop(){this.rafId!==null&&(this.cancelFrame(this.rafId),this.rafId=null)}}class po{constructor(e,t=2048){u(this,"context",null);u(this,"processor",null);u(this,"targetSampleRate",22050);u(this,"bufferSize");u(this,"onBufferRequest");u(this,"glitchCount",0);u(this,"lastCallbackTime",0);u(this,"isRunning",!1);this.onBufferRequest=e,this.bufferSize=t}async start(){if(!this.isRunning){try{this.context=new(window.AudioContext||window.webkitAudioContext)({sampleRate:this.targetSampleRate})}catch{this.context=new(window.AudioContext||window.webkitAudioContext),console.warn(`Could not create AudioContext at ${this.targetSampleRate}Hz, using ${this.context.sampleRate}Hz. Audio may play at wrong pitch if not resampled by mixer.`)}this.context.state==="suspended"&&await this.context.resume(),this.processor=this.context.createScriptProcessor(this.bufferSize,0,1),this.processor.onaudioprocess=e=>{this.handleAudioProcess(e)},this.processor.connect(this.context.destination),this.isRunning=!0,this.lastCallbackTime=performance.now()}}stop(){this.isRunning&&(this.processor&&(this.processor.disconnect(),this.processor.onaudioprocess=null,this.processor=null),this.context&&(this.context.state!=="closed"&&this.context.close(),this.context=null),this.isRunning=!1)}handleAudioProcess(e){if(!this.isRunning||!this.context)return;const t=performance.now(),i=e.outputBuffer.getChannelData(0),a=this.bufferSize/this.context.sampleRate*1e3,n=t-this.lastCallbackTime;this.lastCallbackTime>0&&n>a*1.5&&(this.glitchCount++,console.warn(`Audio glitch detected! Interval: ${n.toFixed(2)}ms, Expected: ${a.toFixed(2)}ms. Total glitches: ${this.glitchCount}`)),this.lastCallbackTime=t,this.onBufferRequest(i)}getGlitchCount(){return this.glitchCount}getSampleRate(){var e;return((e=this.context)==null?void 0:e.sampleRate)??0}isActive(){return this.isRunning}}function yo(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function wo(r){if(r.__esModule)return r;var e=r.default;if(typeof e=="function"){var t=function i(){return this instanceof i?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(r).forEach(function(i){var a=Object.getOwnPropertyDescriptor(r,i);Object.defineProperty(t,i,a.get?a:{enumerable:!0,get:function(){return r[i]}})}),t}var On={exports:{}};function vo(r){throw new Error('Could not dynamically require "'+r+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var wr={exports:{}};const bo={},Eo=Object.freeze(Object.defineProperty({__proto__:null,default:bo},Symbol.toStringTag,{value:"Module"})),bn=wo(Eo);var En;function To(){return En||(En=1,function(r,e){var t=function(){var i=typeof document<"u"&&document.currentScript?document.currentScript.src:void 0;return function(a){a=a||{};var n=typeof a<"u"?a:{},l={},d;for(d in n)n.hasOwnProperty(d)&&(l[d]=n[d]);n.arguments=[],n.thisProgram="./this.program",n.quit=function(o,s){throw s},n.preRun=[],n.postRun=[];var v=!1,b=!1,C=!1,E=!1;v=typeof window=="object",b=typeof importScripts=="function",C=typeof process=="object"&&typeof vo=="function"&&!v&&!b,E=!v&&!C&&!b;var A="";function $(o){return n.locateFile?n.locateFile(o,A):A+o}if(C){A=__dirname+"/";var K,q;n.read=function(s,c){var f;return K||(K=bn),q||(q=bn),s=q.normalize(s),f=K.readFileSync(s),c?f:f.toString()},n.readBinary=function(s){var c=n.read(s,!0);return c.buffer||(c=new Uint8Array(c)),j(c.buffer),c},process.argv.length>1&&(n.thisProgram=process.argv[1].replace(/\\/g,"/")),n.arguments=process.argv.slice(2),process.on("unhandledRejection",Ee),n.quit=function(o){process.exit(o)},n.inspect=function(){return"[Emscripten Module object]"}}else E?(typeof read<"u"&&(n.read=function(s){return read(s)}),n.readBinary=function(s){var c;return typeof readbuffer=="function"?new Uint8Array(readbuffer(s)):(c=read(s,"binary"),j(typeof c=="object"),c)},typeof scriptArgs<"u"?n.arguments=scriptArgs:typeof arguments<"u"&&(n.arguments=arguments),typeof quit=="function"&&(n.quit=function(o){quit(o)})):(v||b)&&(b?A=self.location.href:document.currentScript&&(A=document.currentScript.src),i&&(A=i),A.indexOf("blob:")!==0?A=A.substr(0,A.lastIndexOf("/")+1):A="",n.read=function(s){var c=new XMLHttpRequest;return c.open("GET",s,!1),c.send(null),c.responseText},b&&(n.readBinary=function(s){var c=new XMLHttpRequest;return c.open("GET",s,!1),c.responseType="arraybuffer",c.send(null),new Uint8Array(c.response)}),n.readAsync=function(s,c,f){var h=new XMLHttpRequest;h.open("GET",s,!0),h.responseType="arraybuffer",h.onload=function(){if(h.status==200||h.status==0&&h.response){c(h.response);return}f()},h.onerror=f,h.send(null)},n.setWindowTitle=function(o){document.title=o});var U=n.print||(typeof console<"u"?console.log.bind(console):typeof print<"u"?print:null),x=n.printErr||(typeof printErr<"u"?printErr:typeof console<"u"&&console.warn.bind(console)||U);for(d in l)l.hasOwnProperty(d)&&(n[d]=l[d]);l=void 0;var Ke=16;function H(o){var s=be;return be=be+o+15&-16,s}function fe(o,s){s||(s=Ke);var c=o=Math.ceil(o/s)*s;return c}var we={"f64-rem":function(o,s){return o%s},debugger:function(){debugger}};new Array(0);var $e=1024,xe=!1;function j(o,s){o||Ee("Assertion failed: "+s)}function Ce(o,s){if(s===0||!o)return"";for(var c=0,f,h=0;f=W[o+h>>0],c|=f,!(f==0&&!s||(h++,s&&h==s)););s||(s=h);var g="";if(c<128){for(var y=1024,m;s>0;)m=String.fromCharCode.apply(String,W.subarray(o,o+Math.min(s,y))),g=g?g+m:m,o+=y,s-=y;return g}return We(o)}var he=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function Y(o,s){for(var c=s;o[c];)++c;if(c-s>16&&o.subarray&&he)return he.decode(o.subarray(s,c));for(var f,h,g,y,m,p,w="";;){if(f=o[s++],!f)return w;if(!(f&128)){w+=String.fromCharCode(f);continue}if(h=o[s++]&63,(f&224)==192){w+=String.fromCharCode((f&31)<<6|h);continue}if(g=o[s++]&63,(f&240)==224?f=(f&15)<<12|h<<6|g:(y=o[s++]&63,(f&248)==240?f=(f&7)<<18|h<<12|g<<6|y:(m=o[s++]&63,(f&252)==248?f=(f&3)<<24|h<<18|g<<12|y<<6|m:(p=o[s++]&63,f=(f&1)<<30|h<<24|g<<18|y<<12|m<<6|p))),f<65536)w+=String.fromCharCode(f);else{var _=f-65536;w+=String.fromCharCode(55296|_>>10,56320|_&1023)}}}function We(o){return Y(W,o)}function lt(o,s,c,f){if(!(f>0))return 0;for(var h=c,g=c+f-1,y=0;y<o.length;++y){var m=o.charCodeAt(y);if(m>=55296&&m<=57343){var p=o.charCodeAt(++y);m=65536+((m&1023)<<10)|p&1023}if(m<=127){if(c>=g)break;s[c++]=m}else if(m<=2047){if(c+1>=g)break;s[c++]=192|m>>6,s[c++]=128|m&63}else if(m<=65535){if(c+2>=g)break;s[c++]=224|m>>12,s[c++]=128|m>>6&63,s[c++]=128|m&63}else if(m<=2097151){if(c+3>=g)break;s[c++]=240|m>>18,s[c++]=128|m>>12&63,s[c++]=128|m>>6&63,s[c++]=128|m&63}else if(m<=67108863){if(c+4>=g)break;s[c++]=248|m>>24,s[c++]=128|m>>18&63,s[c++]=128|m>>12&63,s[c++]=128|m>>6&63,s[c++]=128|m&63}else{if(c+5>=g)break;s[c++]=252|m>>30,s[c++]=128|m>>24&63,s[c++]=128|m>>18&63,s[c++]=128|m>>12&63,s[c++]=128|m>>6&63,s[c++]=128|m&63}}return s[c]=0,c-h}function ft(o,s,c){return lt(o,W,s,c)}function qe(o){for(var s=0,c=0;c<o.length;++c){var f=o.charCodeAt(c);f>=55296&&f<=57343&&(f=65536+((f&1023)<<10)|o.charCodeAt(++c)&1023),f<=127?++s:f<=2047?s+=2:f<=65535?s+=3:f<=2097151?s+=4:f<=67108863?s+=5:s+=6}return s}typeof TextDecoder<"u"&&new TextDecoder("utf-16le");var ee=65536,Pe=16777216;function Re(o,s){return o%s>0&&(o+=s-o%s),o}var k,ht,W,Ne,ve,te,X,je,Xe;function Ct(o){n.buffer=k=o}function dt(){n.HEAP8=ht=new Int8Array(k),n.HEAP16=Ne=new Int16Array(k),n.HEAP32=te=new Int32Array(k),n.HEAPU8=W=new Uint8Array(k),n.HEAPU16=ve=new Uint16Array(k),n.HEAPU32=X=new Uint32Array(k),n.HEAPF32=je=new Float32Array(k),n.HEAPF64=Xe=new Float64Array(k)}var Je,be,Ze,Qe,qt,jt,Pt;Je=be=Ze=Qe=qt=jt=Pt=0;function zr(){Ee("Cannot enlarge memory arrays. Either (1) compile with  -s TOTAL_MEMORY=X  with X higher than the current value "+ze+", (2) compile with  -s ALLOW_MEMORY_GROWTH=1  which allows increasing the size at runtime, or (3) if you want malloc to return NULL (0) instead of this abort, compile with  -s ABORTING_MALLOC=0 ")}function Gn(){zr()}var Xt=n.TOTAL_STACK||8192,ze=n.TOTAL_MEMORY||65536;ze<Xt&&x("TOTAL_MEMORY should be larger than TOTAL_STACK, was "+ze+"! (TOTAL_STACK="+Xt+")"),n.buffer?k=n.buffer:(typeof WebAssembly=="object"&&typeof WebAssembly.Memory=="function"?(n.wasmMemory=new WebAssembly.Memory({initial:ze/ee,maximum:ze/ee}),k=n.wasmMemory.buffer):k=new ArrayBuffer(ze),n.buffer=k),dt();function Kn(){return ze}function Rt(o){for(;o.length>0;){var s=o.shift();if(typeof s=="function"){s();continue}var c=s.func;typeof c=="number"?s.arg===void 0?n.dynCall_v(c):n.dynCall_vi(c,s.arg):c(s.arg===void 0?null:s.arg)}}var Ur=[],Hr=[],qn=[],Yr=[],Vr=!1;function jn(){if(n.preRun)for(typeof n.preRun=="function"&&(n.preRun=[n.preRun]);n.preRun.length;)Qn(n.preRun.shift());Rt(Ur)}function Xn(){Vr||(Vr=!0,Rt(Hr))}function Jn(){Rt(qn)}function Zn(){if(n.postRun)for(typeof n.postRun=="function"&&(n.postRun=[n.postRun]);n.postRun.length;)ei(n.postRun.shift());Rt(Yr)}function Qn(o){Ur.unshift(o)}function ei(o){Yr.unshift(o)}var Ue=0,mt=null;function ti(o){Ue++,n.monitorRunDependencies&&n.monitorRunDependencies(Ue)}function ri(o){if(Ue--,n.monitorRunDependencies&&n.monitorRunDependencies(Ue),Ue==0&&mt){var s=mt;mt=null,s()}}n.preloadedImages={},n.preloadedAudios={};var Gr="data:application/octet-stream;base64,";function Lt(o){return String.prototype.startsWith?o.startsWith(Gr):o.indexOf(Gr)===0}function ni(){var o="opl.wast",s="opl.wasm",c="opl.temp.asm.js";Lt(o)||(o=$(o)),Lt(s)||(s=$(s)),Lt(c)||(c=$(c));var f=64*1024,h={global:null,env:null,asm2wasm:we,parent:n},g=null;function y(M){var R=n.buffer;M.byteLength<R.byteLength&&x("the new buffer in mergeMemory is smaller than the previous one. in native wasm, we should grow memory here");var V=new Int8Array(R),z=new Int8Array(M);z.set(V),Ct(M),dt()}function m(){try{if(n.wasmBinary)return new Uint8Array(n.wasmBinary);if(n.readBinary)return n.readBinary(s);throw"both async and sync fetching of the wasm failed"}catch(M){Ee(M)}}function p(){return!n.wasmBinary&&(v||b)&&typeof fetch=="function"?fetch(s,{credentials:"same-origin"}).then(function(M){if(!M.ok)throw"failed to load wasm binary file at '"+s+"'";return M.arrayBuffer()}).catch(function(){return m()}):new Promise(function(M,R){M(m())})}function w(M,R,V){if(typeof WebAssembly!="object")return x("no native wasm support detected"),!1;if(!(n.wasmMemory instanceof WebAssembly.Memory))return x("no native wasm Memory in use"),!1;R.memory=n.wasmMemory,h.global={NaN:NaN,Infinity:1/0},h["global.Math"]=Math,h.env=R;function z(G,Ye){g=G.exports,g.memory&&y(g.memory),n.asm=g,n.usingWasm=!0,ri()}if(ti(),n.instantiateWasm)try{return n.instantiateWasm(h,z)}catch(G){return x("Module.instantiateWasm callback failed with error: "+G),!1}function J(G){z(G.instance,G.module)}function me(G){p().then(function(Ye){return WebAssembly.instantiate(Ye,h)}).then(G,function(Ye){x("failed to asynchronously prepare wasm: "+Ye),Ee(Ye)})}return!n.wasmBinary&&typeof WebAssembly.instantiateStreaming=="function"&&!Lt(s)&&typeof fetch=="function"?WebAssembly.instantiateStreaming(fetch(s,{credentials:"same-origin"}),h).then(J,function(G){x("wasm streaming compile failed: "+G),x("falling back to ArrayBuffer instantiation"),me(J)}):me(J),{}}n.asmPreload=n.asm;var _=n.reallocBuffer,B=function(M){var R=n.usingWasm?ee:Pe;M=Re(M,R);var V=n.buffer,z=V.byteLength;if(n.usingWasm)try{var J=n.wasmMemory.grow((M-z)/f);return J!==-1?n.buffer=n.wasmMemory.buffer:null}catch{return null}};n.reallocBuffer=function(M){return L==="asmjs"?_(M):B(M)};var L="";n.asm=function(M,R,V){if(!R.table){var z=n.wasmTableSize;z===void 0&&(z=1024);var J=n.wasmMaxTableSize;typeof WebAssembly=="object"&&typeof WebAssembly.Table=="function"?J!==void 0?R.table=new WebAssembly.Table({initial:z,maximum:J,element:"anyfunc"}):R.table=new WebAssembly.Table({initial:z,element:"anyfunc"}):R.table=new Array(z),n.wasmTable=R.table}R.memoryBase||(R.memoryBase=n.STATIC_BASE),R.tableBase||(R.tableBase=0);var me;return me=w(M,R),j(me,"no binaryen method succeeded."),me}}ni();var ii=[function(){throw new Error("OPL.generate() cannot generate more than 512 samples per call")},function(){throw new Error("OPL.generate() cannot generate fewer than 2 samples per call")}];function si(o){return ii[o]()}Je=$e,be=Je+17392,Hr.push({func:function(){ms()}},{func:function(){ds()}});var oi=17392;n.STATIC_BASE=Je,n.STATIC_BUMP=oi,be+=16;var N={buffers:[null,[],[]],printChar:function(o,s){var c=N.buffers[o];j(c),s===0||s===10?((o===1?U:x)(Y(c,0)),c.length=0):c.push(s)},varargs:0,get:function(o){N.varargs+=4;var s=te[N.varargs-4>>2];return s},getStr:function(){var o=Ce(N.get());return o},get64:function(){var o=N.get(),s=N.get();return o>=0?j(s===0):j(s===-1),o},getZero:function(){j(N.get()===0)}};function ai(o,s){N.varargs=s;try{var c=N.getStreamFromFD(),f=N.get(),h=N.get(),g=N.get(),y=N.get(),m=h;return FS.llseek(c,m,y),te[g>>2]=c.position,c.getdents&&m===0&&y===0&&(c.getdents=null),0}catch(p){return(typeof FS>"u"||!(p instanceof FS.ErrnoError))&&Ee(p),-p.errno}}function ci(o,s){N.varargs=s;try{for(var c=N.get(),f=N.get(),h=N.get(),g=0,y=0;y<h;y++){for(var m=te[f+y*8>>2],p=te[f+(y*8+4)>>2],w=0;w<p;w++)N.printChar(c,W[m+w]);g+=p}return g}catch(_){return(typeof FS>"u"||!(_ instanceof FS.ErrnoError))&&Ee(_),-_.errno}}function ui(o,s){N.varargs=s;try{var c=N.getStreamFromFD();return FS.close(c),0}catch(f){return(typeof FS>"u"||!(f instanceof FS.ErrnoError))&&Ee(f),-f.errno}}function Jt(o){switch(o){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+o)}}function li(){for(var o=new Array(256),s=0;s<256;++s)o[s]=String.fromCharCode(s);Kr=o}var Kr=void 0;function ie(o){for(var s="",c=o;W[c];)s+=Kr[W[c++]];return s}var et={},He={},Ft={},fi=48,hi=57;function Zt(o){if(o===void 0)return"_unknown";o=o.replace(/[^a-zA-Z0-9_]/g,"$");var s=o.charCodeAt(0);return s>=fi&&s<=hi?"_"+o:o}function Qt(o,s){return o=Zt(o),new Function("body","return function "+o+`() {
    "use strict";    return body.apply(this, arguments);
};
`)(s)}function er(o,s){var c=Qt(s,function(f){this.name=s,this.message=f;var h=new Error(f).stack;h!==void 0&&(this.stack=this.toString()+`
`+h.replace(/^Error(:[^\n]*)?\n/,""))});return c.prototype=Object.create(o.prototype),c.prototype.constructor=c,c.prototype.toString=function(){return this.message===void 0?this.name:this.name+": "+this.message},c}var tt=void 0;function P(o){throw new tt(o)}var qr=void 0;function kt(o){throw new qr(o)}function gt(o,s,c){o.forEach(function(m){Ft[m]=s});function f(m){var p=c(m);p.length!==o.length&&kt("Mismatched type converter count");for(var w=0;w<o.length;++w)Se(o[w],p[w])}var h=new Array(s.length),g=[],y=0;s.forEach(function(m,p){He.hasOwnProperty(m)?h[p]=He[m]:(g.push(m),et.hasOwnProperty(m)||(et[m]=[]),et[m].push(function(){h[p]=He[m],++y,y===g.length&&f(h)}))}),g.length===0&&f(h)}function Se(o,s,c){if(c=c||{},!("argPackAdvance"in s))throw new TypeError("registerType registeredInstance requires argPackAdvance");var f=s.name;if(o||P('type "'+f+'" must have a positive integer typeid pointer'),He.hasOwnProperty(o)){if(c.ignoreDuplicateRegistrations)return;P("Cannot register type '"+f+"' twice")}if(He[o]=s,delete Ft[o],et.hasOwnProperty(o)){var h=et[o];delete et[o],h.forEach(function(g){g()})}}function di(o,s,c,f,h){var g=Jt(c);s=ie(s),Se(o,{name:s,fromWireType:function(y){return!!y},toWireType:function(y,m){return m?f:h},argPackAdvance:8,readValueFromPointer:function(y){var m;if(c===1)m=ht;else if(c===2)m=Ne;else if(c===4)m=te;else throw new TypeError("Unknown boolean type size: "+s);return this.fromWireType(m[y>>g])},destructorFunction:null})}function mi(o){if(!(this instanceof Le)||!(o instanceof Le))return!1;for(var s=this.$$.ptrType.registeredClass,c=this.$$.ptr,f=o.$$.ptrType.registeredClass,h=o.$$.ptr;s.baseClass;)c=s.upcast(c),s=s.baseClass;for(;f.baseClass;)h=f.upcast(h),f=f.baseClass;return s===f&&c===h}function gi(o){return{count:o.count,deleteScheduled:o.deleteScheduled,preservePointerOnDelete:o.preservePointerOnDelete,ptr:o.ptr,ptrType:o.ptrType,smartPtr:o.smartPtr,smartPtrType:o.smartPtrType}}function tr(o){function s(c){return c.$$.ptrType.registeredClass.name}P(s(o)+" instance already deleted")}function pi(){if(this.$$.ptr||tr(this),this.$$.preservePointerOnDelete)return this.$$.count.value+=1,this;var o=Object.create(Object.getPrototypeOf(this),{$$:{value:gi(this.$$)}});return o.$$.count.value+=1,o.$$.deleteScheduled=!1,o}function yi(o){var s=o.$$;s.smartPtr?s.smartPtrType.rawDestructor(s.smartPtr):s.ptrType.registeredClass.rawDestructor(s.ptr)}function wi(){this.$$.ptr||tr(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&P("Object already scheduled for deletion"),this.$$.count.value-=1;var o=this.$$.count.value===0;o&&yi(this),this.$$.preservePointerOnDelete||(this.$$.smartPtr=void 0,this.$$.ptr=void 0)}function vi(){return!this.$$.ptr}var pt=void 0,yt=[];function rr(){for(;yt.length;){var o=yt.pop();o.$$.deleteScheduled=!1,o.delete()}}function bi(){return this.$$.ptr||tr(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&P("Object already scheduled for deletion"),yt.push(this),yt.length===1&&pt&&pt(rr),this.$$.deleteScheduled=!0,this}function Ei(){Le.prototype.isAliasOf=mi,Le.prototype.clone=pi,Le.prototype.delete=wi,Le.prototype.isDeleted=vi,Le.prototype.deleteLater=bi}function Le(){}var jr={};function Xr(o,s,c){if(o[s].overloadTable===void 0){var f=o[s];o[s]=function(){return o[s].overloadTable.hasOwnProperty(arguments.length)||P("Function '"+c+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+o[s].overloadTable+")!"),o[s].overloadTable[arguments.length].apply(this,arguments)},o[s].overloadTable=[],o[s].overloadTable[f.argCount]=f}}function Ti(o,s,c){n.hasOwnProperty(o)?(P("Cannot register public name '"+o+"' twice"),Xr(n,o,o),n.hasOwnProperty(c)&&P("Cannot register multiple overloads of a function with the same number of arguments ("+c+")!"),n[o].overloadTable[c]=s):n[o]=s}function _i(o,s,c,f,h,g,y,m){this.name=o,this.constructor=s,this.instancePrototype=c,this.rawDestructor=f,this.baseClass=h,this.getActualType=g,this.upcast=y,this.downcast=m,this.pureVirtualFunctions=[]}function nr(o,s,c){for(;s!==c;)s.upcast||P("Expected null or instance of "+c.name+", got an instance of "+s.name),o=s.upcast(o),s=s.baseClass;return o}function Si(o,s){if(s===null)return this.isReference&&P("null is not a valid "+this.name),0;s.$$||P('Cannot pass "'+nt(s)+'" as a '+this.name),s.$$.ptr||P("Cannot pass deleted object as a pointer of type "+this.name);var c=s.$$.ptrType.registeredClass,f=nr(s.$$.ptr,c,this.registeredClass);return f}function Ai(o,s){var c;if(s===null)return this.isReference&&P("null is not a valid "+this.name),this.isSmartPointer?(c=this.rawConstructor(),o!==null&&o.push(this.rawDestructor,c),c):0;s.$$||P('Cannot pass "'+nt(s)+'" as a '+this.name),s.$$.ptr||P("Cannot pass deleted object as a pointer of type "+this.name),!this.isConst&&s.$$.ptrType.isConst&&P("Cannot convert argument of type "+(s.$$.smartPtrType?s.$$.smartPtrType.name:s.$$.ptrType.name)+" to parameter type "+this.name);var f=s.$$.ptrType.registeredClass;if(c=nr(s.$$.ptr,f,this.registeredClass),this.isSmartPointer)switch(s.$$.smartPtr===void 0&&P("Passing raw pointer to smart pointer is illegal"),this.sharingPolicy){case 0:s.$$.smartPtrType===this?c=s.$$.smartPtr:P("Cannot convert argument of type "+(s.$$.smartPtrType?s.$$.smartPtrType.name:s.$$.ptrType.name)+" to parameter type "+this.name);break;case 1:c=s.$$.smartPtr;break;case 2:if(s.$$.smartPtrType===this)c=s.$$.smartPtr;else{var h=s.clone();c=this.rawShare(c,or(function(){h.delete()})),o!==null&&o.push(this.rawDestructor,c)}break;default:P("Unsupporting sharing policy")}return c}function Mi(o,s){if(s===null)return this.isReference&&P("null is not a valid "+this.name),0;s.$$||P('Cannot pass "'+nt(s)+'" as a '+this.name),s.$$.ptr||P("Cannot pass deleted object as a pointer of type "+this.name),s.$$.ptrType.isConst&&P("Cannot convert argument of type "+s.$$.ptrType.name+" to parameter type "+this.name);var c=s.$$.ptrType.registeredClass,f=nr(s.$$.ptr,c,this.registeredClass);return f}function Bt(o){return this.fromWireType(X[o>>2])}function Ci(o){return this.rawGetPointee&&(o=this.rawGetPointee(o)),o}function Pi(o){this.rawDestructor&&this.rawDestructor(o)}function Ri(o){o!==null&&o.delete()}function Jr(o,s,c){if(s===c)return o;if(c.baseClass===void 0)return null;var f=Jr(o,s,c.baseClass);return f===null?null:c.downcast(f)}function Li(){return Object.keys(wt).length}function Fi(){var o=[];for(var s in wt)wt.hasOwnProperty(s)&&o.push(wt[s]);return o}function ki(o){pt=o,yt.length&&pt&&pt(rr)}function Bi(){n.getInheritedInstanceCount=Li,n.getLiveInheritedInstances=Fi,n.flushPendingDeletes=rr,n.setDelayFunction=ki}var wt={};function Ii(o,s){for(s===void 0&&P("ptr should not be undefined");o.baseClass;)s=o.upcast(s),o=o.baseClass;return s}function Di(o,s){return s=Ii(o,s),wt[s]}function It(o,s){(!s.ptrType||!s.ptr)&&kt("makeClassHandle requires ptr and ptrType");var c=!!s.smartPtrType,f=!!s.smartPtr;return c!==f&&kt("Both smartPtrType and smartPtr must be specified"),s.count={value:1},Object.create(o,{$$:{value:s}})}function Oi(o){var s=this.getPointee(o);if(!s)return this.destructor(o),null;var c=Di(this.registeredClass,s);if(c!==void 0){if(c.$$.count.value===0)return c.$$.ptr=s,c.$$.smartPtr=o,c.clone();var f=c.clone();return this.destructor(o),f}function h(){return this.isSmartPointer?It(this.registeredClass.instancePrototype,{ptrType:this.pointeeType,ptr:s,smartPtrType:this,smartPtr:o}):It(this.registeredClass.instancePrototype,{ptrType:this,ptr:o})}var g=this.registeredClass.getActualType(s),y=jr[g];if(!y)return h.call(this);var m;this.isConst?m=y.constPointerType:m=y.pointerType;var p=Jr(s,this.registeredClass,m.registeredClass);return p===null?h.call(this):this.isSmartPointer?It(m.registeredClass.instancePrototype,{ptrType:m,ptr:p,smartPtrType:this,smartPtr:o}):It(m.registeredClass.instancePrototype,{ptrType:m,ptr:p})}function $i(){Ae.prototype.getPointee=Ci,Ae.prototype.destructor=Pi,Ae.prototype.argPackAdvance=8,Ae.prototype.readValueFromPointer=Bt,Ae.prototype.deleteObject=Ri,Ae.prototype.fromWireType=Oi}function Ae(o,s,c,f,h,g,y,m,p,w,_){this.name=o,this.registeredClass=s,this.isReference=c,this.isConst=f,this.isSmartPointer=h,this.pointeeType=g,this.sharingPolicy=y,this.rawGetPointee=m,this.rawConstructor=p,this.rawShare=w,this.rawDestructor=_,!h&&s.baseClass===void 0?f?(this.toWireType=Si,this.destructorFunction=null):(this.toWireType=Mi,this.destructorFunction=null):this.toWireType=Ai}function xi(o,s,c){n.hasOwnProperty(o)||kt("Replacing nonexistant public symbol"),n[o].overloadTable!==void 0&&c!==void 0||(n[o]=s,n[o].argCount=c)}function rt(o,s){o=ie(o);function c(g){for(var y=[],m=1;m<o.length;++m)y.push("a"+m);var p="dynCall_"+o+"_"+s,w="return function "+p+"("+y.join(", ")+`) {
`;return w+="    return dynCall(rawFunction"+(y.length?", ":"")+y.join(", ")+`);
`,w+=`};
`,new Function("dynCall","rawFunction",w)(g,s)}var f;if(n["FUNCTION_TABLE_"+o]!==void 0)f=n["FUNCTION_TABLE_"+o][s];else if(typeof FUNCTION_TABLE<"u")f=FUNCTION_TABLE[s];else{var h=n.asm["dynCall_"+o];h===void 0&&(h=n.asm["dynCall_"+o.replace(/f/g,"d")],h===void 0&&P("No dynCall invoker for signature: "+o)),f=c(h)}return typeof f!="function"&&P("unknown function pointer with signature "+o+": "+s),f}var Zr=void 0;function Qr(o){var s=gs(o),c=ie(s);return Fe(s),c}function ir(o,s){var c=[],f={};function h(g){if(!f[g]&&!He[g]){if(Ft[g]){Ft[g].forEach(h);return}c.push(g),f[g]=!0}}throw s.forEach(h),new Zr(o+": "+c.map(Qr).join([", "]))}function Wi(o,s,c,f,h,g,y,m,p,w,_,B,L){_=ie(_),g=rt(h,g),m&&(m=rt(y,m)),w&&(w=rt(p,w)),L=rt(B,L);var M=Zt(_);Ti(M,function(){ir("Cannot construct "+_+" due to unbound types",[f])}),gt([o,s,c],f?[f]:[],function(R){R=R[0];var V,z;f?(V=R.registeredClass,z=V.instancePrototype):z=Le.prototype;var J=Qt(M,function(){if(Object.getPrototypeOf(this)!==me)throw new tt("Use 'new' to construct "+_);if(G.constructor_body===void 0)throw new tt(_+" has no accessible constructor");var un=G.constructor_body[arguments.length];if(un===void 0)throw new tt("Tried to invoke ctor of "+_+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(G.constructor_body).toString()+") parameters instead!");return un.apply(this,arguments)}),me=Object.create(z,{constructor:{value:J}});J.prototype=me;var G=new _i(_,J,me,L,V,g,m,w),Ye=new Ae(_,G,!0,!1,!1),an=new Ae(_+"*",G,!1,!1,!1),cn=new Ae(_+" const*",G,!1,!0,!1);return jr[o]={pointerType:an,constPointerType:cn},xi(M,J),[Ye,an,cn]})}function en(o,s){for(var c=[],f=0;f<o;f++)c.push(te[(s>>2)+f]);return c}function tn(o){for(;o.length;){var s=o.pop(),c=o.pop();c(s)}}function Ni(o,s,c,f,h,g){var y=en(s,c);h=rt(f,h),gt([],[o],function(m){m=m[0];var p="constructor "+m.name;if(m.registeredClass.constructor_body===void 0&&(m.registeredClass.constructor_body=[]),m.registeredClass.constructor_body[s-1]!==void 0)throw new tt("Cannot register multiple constructors with identical number of parameters ("+(s-1)+") for class '"+m.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return m.registeredClass.constructor_body[s-1]=function(){ir("Cannot construct "+m.name+" due to unbound types",y)},gt([],y,function(w){return m.registeredClass.constructor_body[s-1]=function(){arguments.length!==s-1&&P(p+" called with "+arguments.length+" arguments, expected "+(s-1));var B=[],L=new Array(s);L[0]=g;for(var M=1;M<s;++M)L[M]=w[M].toWireType(B,arguments[M-1]);var R=h.apply(null,L);return tn(B),w[0].fromWireType(R)},[]}),[]})}function zi(o,s){if(!(o instanceof Function))throw new TypeError("new_ called with constructor type "+typeof o+" which is not a function");var c=Qt(o.name||"unknownFunctionName",function(){});c.prototype=o.prototype;var f=new c,h=o.apply(f,s);return h instanceof Object?h:f}function Ui(o,s,c,f,h){var g=s.length;g<2&&P("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var y=s[1]!==null&&c!==null,m=!1,p=1;p<s.length;++p)if(s[p]!==null&&s[p].destructorFunction===void 0){m=!0;break}for(var w=s[0].name!=="void",_="",B="",p=0;p<g-2;++p)_+=(p!==0?", ":"")+"arg"+p,B+=(p!==0?", ":"")+"arg"+p+"Wired";var L="return function "+Zt(o)+"("+_+`) {
if (arguments.length !== `+(g-2)+`) {
throwBindingError('function `+o+" called with ' + arguments.length + ' arguments, expected "+(g-2)+` args!');
}
`;m&&(L+=`var destructors = [];
`);var M=m?"destructors":"null",R=["throwBindingError","invoker","fn","runDestructors","retType","classParam"],V=[P,f,h,tn,s[0],s[1]];y&&(L+="var thisWired = classParam.toWireType("+M+`, this);
`);for(var p=0;p<g-2;++p)L+="var arg"+p+"Wired = argType"+p+".toWireType("+M+", arg"+p+"); // "+s[p+2].name+`
`,R.push("argType"+p),V.push(s[p+2]);if(y&&(B="thisWired"+(B.length>0?", ":"")+B),L+=(w?"var rv = ":"")+"invoker(fn"+(B.length>0?", ":"")+B+`);
`,m)L+=`runDestructors(destructors);
`;else for(var p=y?1:2;p<s.length;++p){var z=p===1?"thisWired":"arg"+(p-2)+"Wired";s[p].destructorFunction!==null&&(L+=z+"_dtor("+z+"); // "+s[p].name+`
`,R.push(z+"_dtor"),V.push(s[p].destructorFunction))}w&&(L+=`var ret = retType.fromWireType(rv);
return ret;
`),L+=`}
`,R.push(L);var J=zi(Function,R).apply(null,V);return J}function Hi(o,s,c,f,h,g,y,m){var p=en(c,f);s=ie(s),g=rt(h,g),gt([],[o],function(w){w=w[0];var _=w.name+"."+s;m&&w.registeredClass.pureVirtualFunctions.push(s);function B(){ir("Cannot call "+_+" due to unbound types",p)}var L=w.registeredClass.instancePrototype,M=L[s];return M===void 0||M.overloadTable===void 0&&M.className!==w.name&&M.argCount===c-2?(B.argCount=c-2,B.className=w.name,L[s]=B):(Xr(L,s,_),L[s].overloadTable[c-2]=B),gt([],p,function(R){var V=Ui(_,R,w,g,y);return L[s].overloadTable===void 0?(V.argCount=c-2,L[s]=V):L[s].overloadTable[c-2]=V,[]}),[]})}var sr=[],de=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function rn(o){o>4&&--de[o].refcount===0&&(de[o]=void 0,sr.push(o))}function Yi(){for(var o=0,s=5;s<de.length;++s)de[s]!==void 0&&++o;return o}function Vi(){for(var o=5;o<de.length;++o)if(de[o]!==void 0)return de[o];return null}function Gi(){n.count_emval_handles=Yi,n.get_first_emval=Vi}function or(o){switch(o){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:{var s=sr.length?sr.pop():de.length;return de[s]={refcount:1,value:o},s}}}function Ki(o,s){s=ie(s),Se(o,{name:s,fromWireType:function(c){var f=de[c].value;return rn(c),f},toWireType:function(c,f){return or(f)},argPackAdvance:8,readValueFromPointer:Bt,destructorFunction:null})}function nt(o){if(o===null)return"null";var s=typeof o;return s==="object"||s==="array"||s==="function"?o.toString():""+o}function qi(o,s){switch(s){case 2:return function(c){return this.fromWireType(je[c>>2])};case 3:return function(c){return this.fromWireType(Xe[c>>3])};default:throw new TypeError("Unknown float type: "+o)}}function ji(o,s,c){var f=Jt(c);s=ie(s),Se(o,{name:s,fromWireType:function(h){return h},toWireType:function(h,g){if(typeof g!="number"&&typeof g!="boolean")throw new TypeError('Cannot convert "'+nt(g)+'" to '+this.name);return g},argPackAdvance:8,readValueFromPointer:qi(s,f),destructorFunction:null})}function Xi(o,s,c){switch(s){case 0:return c?function(h){return ht[h]}:function(h){return W[h]};case 1:return c?function(h){return Ne[h>>1]}:function(h){return ve[h>>1]};case 2:return c?function(h){return te[h>>2]}:function(h){return X[h>>2]};default:throw new TypeError("Unknown integer type: "+o)}}function Ji(o,s,c,f,h){s=ie(s),h===-1&&(h=4294967295);var g=Jt(c),y=function(w){return w};if(f===0){var m=32-8*c;y=function(w){return w<<m>>>m}}var p=s.indexOf("unsigned")!=-1;Se(o,{name:s,fromWireType:y,toWireType:function(w,_){if(typeof _!="number"&&typeof _!="boolean")throw new TypeError('Cannot convert "'+nt(_)+'" to '+this.name);if(_<f||_>h)throw new TypeError('Passing a number "'+nt(_)+'" from JS side to C/C++ side to an argument of type "'+s+'", which is outside the valid range ['+f+", "+h+"]!");return p?_>>>0:_|0},argPackAdvance:8,readValueFromPointer:Xi(s,g,f!==0),destructorFunction:null})}function Zi(o,s,c){var f=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],h=f[s];function g(y){y=y>>2;var m=X,p=m[y],w=m[y+1];return new h(m.buffer,w,p)}c=ie(c),Se(o,{name:c,fromWireType:g,argPackAdvance:8,readValueFromPointer:g},{ignoreDuplicateRegistrations:!0})}function Qi(o,s){s=ie(s);var c=s==="std::string";Se(o,{name:s,fromWireType:function(f){var h=X[f>>2],g;if(c){var y=W[f+4+h],m=0;y!=0&&(m=y,W[f+4+h]=0);for(var p=f+4,w=0;w<=h;++w){var _=f+4+w;if(W[_]==0){var B=We(p);g===void 0?g=B:(g+="\0",g+=B),p=_+1}}m!=0&&(W[f+4+h]=m)}else{for(var L=new Array(h),w=0;w<h;++w)L[w]=String.fromCharCode(W[f+4+w]);g=L.join("")}return Fe(f),g},toWireType:function(f,h){h instanceof ArrayBuffer&&(h=new Uint8Array(h));var g,y=typeof h=="string";y||h instanceof Uint8Array||h instanceof Uint8ClampedArray||h instanceof Int8Array||P("Cannot pass non-string to std::string"),c&&y?g=function(){return qe(h)}:g=function(){return h.length};var m=g(),p=on(4+m+1);if(X[p>>2]=m,c&&y)ft(h,p+4,m+1);else if(y)for(var w=0;w<m;++w){var _=h.charCodeAt(w);_>255&&(Fe(p),P("String has UTF-16 code units that do not fit in 8 bits")),W[p+4+w]=_}else for(var w=0;w<m;++w)W[p+4+w]=h[w];return f!==null&&f.push(Fe,p),p},argPackAdvance:8,readValueFromPointer:Bt,destructorFunction:function(f){Fe(f)}})}function es(o,s,c){c=ie(c);var f,h;s===2?(f=function(){return ve},h=1):s===4&&(f=function(){return X},h=2),Se(o,{name:c,fromWireType:function(g){for(var y=f(),m=X[g>>2],p=new Array(m),w=g+4>>h,_=0;_<m;++_)p[_]=String.fromCharCode(y[w+_]);return Fe(g),p.join("")},toWireType:function(g,y){var m=f(),p=y.length,w=on(4+p*s);X[w>>2]=p;for(var _=w+4>>h,B=0;B<p;++B)m[_+B]=y.charCodeAt(B);return g!==null&&g.push(Fe,w),w},argPackAdvance:8,readValueFromPointer:Bt,destructorFunction:function(g){Fe(g)}})}function ts(o,s){s=ie(s),Se(o,{isVoid:!0,name:s,argPackAdvance:0,fromWireType:function(){},toWireType:function(c,f){}})}function rs(o){o>4&&(de[o].refcount+=1)}function ns(o,s){var c=He[o];return c===void 0&&P(s+" has unknown type "+Qr(o)),c}function is(o,s){o=ns(o,"_emval_take_value");var c=o.readValueFromPointer(s);return or(c)}function ss(){n.abort()}function os(o){return Math.pow(2,o)}function as(){return os.apply(null,arguments)}function cs(o,s,c){return W.set(W.subarray(s,s+c),o),o}var Dt={};function us(o){return Dt[o]||0}var ar=1,nn={EINVAL:22};function ls(o,s){return o==0?nn.EINVAL:(te[o>>2]=ar,Dt[ar]=0,ar++,0)}function vt(o,s){vt.seen||(vt.seen={}),!(o in vt.seen)&&(n.dynCall_v(s),vt.seen[o]=1)}function fs(o,s){return o in Dt?(Dt[o]=s,0):nn.EINVAL}function hs(o){return n.___errno_location&&(te[n.___errno_location()>>2]=o),o}li(),tt=n.BindingError=er(Error,"BindingError"),qr=n.InternalError=er(Error,"InternalError"),Ei(),$i(),Bi(),Zr=n.UnboundTypeError=er(Error,"UnboundTypeError"),Gi(),Pt=H(4),Ze=Qe=fe(be),qt=Ze+Xt,jt=fe(qt),te[Pt>>2]=jt,n.wasmTableSize=82,n.wasmMaxTableSize=82,n.asmGlobalArg={},n.asmLibraryArg={abort:Ee,enlargeMemory:Gn,getTotalMemory:Kn,abortOnCannotGrowMemory:zr,___setErrNo:hs,___syscall140:ai,___syscall146:ci,___syscall6:ui,__embind_register_bool:di,__embind_register_class:Wi,__embind_register_class_constructor:Ni,__embind_register_class_function:Hi,__embind_register_emval:Ki,__embind_register_float:ji,__embind_register_integer:Ji,__embind_register_memory_view:Zi,__embind_register_std_string:Qi,__embind_register_std_wstring:es,__embind_register_void:ts,__emval_decref:rn,__emval_incref:rs,__emval_take_value:is,_abort:ss,_emscripten_asm_const_i:si,_emscripten_memcpy_big:cs,_llvm_exp2_f64:as,_pthread_getspecific:us,_pthread_key_create:ls,_pthread_once:vt,_pthread_setspecific:fs,DYNAMICTOP_PTR:Pt,STACKTOP:Qe};var sn=n.asm(n.asmGlobalArg,n.asmLibraryArg,k);n.asm=sn;var ds=n.__GLOBAL__sub_I_bind_cpp=function(){return n.asm.__GLOBAL__sub_I_bind_cpp.apply(null,arguments)},ms=n.__GLOBAL__sub_I_index_cpp=function(){return n.asm.__GLOBAL__sub_I_index_cpp.apply(null,arguments)},gs=n.___getTypeName=function(){return n.asm.___getTypeName.apply(null,arguments)},Fe=n._free=function(){return n.asm._free.apply(null,arguments)},on=n._malloc=function(){return n.asm._malloc.apply(null,arguments)};n.dynCall_ii=function(){return n.asm.dynCall_ii.apply(null,arguments)},n.dynCall_iii=function(){return n.asm.dynCall_iii.apply(null,arguments)},n.dynCall_iiii=function(){return n.asm.dynCall_iiii.apply(null,arguments)},n.dynCall_iiiii=function(){return n.asm.dynCall_iiiii.apply(null,arguments)},n.dynCall_v=function(){return n.asm.dynCall_v.apply(null,arguments)},n.dynCall_vi=function(){return n.asm.dynCall_vi.apply(null,arguments)},n.dynCall_vii=function(){return n.asm.dynCall_vii.apply(null,arguments)},n.dynCall_viii=function(){return n.asm.dynCall_viii.apply(null,arguments)},n.dynCall_viiii=function(){return n.asm.dynCall_viiii.apply(null,arguments)},n.dynCall_viiiii=function(){return n.asm.dynCall_viiiii.apply(null,arguments)},n.dynCall_viiiiii=function(){return n.asm.dynCall_viiiiii.apply(null,arguments)},n.asm=sn,n.then=function(o){if(n.calledRun)o(n);else{var s=n.onRuntimeInitialized;n.onRuntimeInitialized=function(){s&&s(),o(n)}}return n};function cr(o){this.name="ExitStatus",this.message="Program terminated with exit("+o+")",this.status=o}cr.prototype=new Error,cr.prototype.constructor=cr,mt=function o(){n.calledRun||ur(),n.calledRun||(mt=o)};function ur(o){if(o=o||n.arguments,Ue>0||(jn(),Ue>0)||n.calledRun)return;function s(){n.calledRun||(n.calledRun=!0,!xe&&(Xn(),Jn(),n.onRuntimeInitialized&&n.onRuntimeInitialized(),Zn()))}n.setStatus?(n.setStatus("Running..."),setTimeout(function(){setTimeout(function(){n.setStatus("")},1),s()},1)):s()}n.run=ur;function Ee(o){throw n.onAbort&&n.onAbort(o),o!==void 0?(U(o),x(o),o=JSON.stringify(o)):o="",xe=!0,"abort("+o+"). Build with -s ASSERTIONS=1 for more info."}if(n.abort=Ee,n.preInit)for(typeof n.preInit=="function"&&(n.preInit=[n.preInit]);n.preInit.length>0;)n.preInit.pop()();return n.noExitRuntime=!0,ur(),a}}();r.exports=t}(wr)),wr.exports}(function(r){const e=To(),t=2,i=512*2*t;class a{constructor(l,d,v){this.sampleRate=d,this.channelCount=v,this.opl=new l.OPL(d,v,i),this.s16array=this.opl.getBuffer()}static async create(l=49716,d=2){return new Promise((v,b)=>{e().then(C=>{v(new a(C,l,d))})})}generate(l,d=Uint8Array){return this.opl.generate(l),new d(this.s16array.buffer,this.s16array.byteOffset,l*this.channelCount*t)}write(l,d){this.opl.write(l,d)}}r.exports&&(r.exports=a)})(On);var _o=On.exports;const So=yo(_o);class Ao{constructor(){u(this,"opl",null);u(this,"writeBuffer",new Map);u(this,"SAMPLE_RATE",22050);u(this,"initialized",!1)}async init(){this.initialized||(this.opl=await So.create(this.SAMPLE_RATE,1),this.initialized=!0)}opl2Write(e,t){this.writeBuffer.set(e,t)}generateSamples(e){if(!this.initialized||!this.opl)return new Float32Array(e);if(this.writeBuffer.size>0){for(const[a,n]of this.writeBuffer)this.opl.write(a,n);this.writeBuffer.clear()}const t=new Float32Array(e);let i=0;for(;i<e;){const a=Math.min(e-i,512),n=this.opl.generate(a,Int16Array);for(let l=0;l<n.length;l++)t[i+l]=n[l]/32768;i+=n.length}return t}isInitialized(){return this.initialized}}const Ve=class Ve{constructor(){u(this,"channels");this.channels=Array.from({length:Ve.MAX_CHANNELS},()=>({pcmData:null,length:0,position:0,volume:0,isActive:!1}))}allocate(){for(let e=0;e<Ve.MAX_CHANNELS;e++)if(!this.channels[e].isActive)return e;return-1}release(e){this.isValidChannel(e)&&this.stop(e)}play(e,t,i){if(!this.isValidChannel(e))return;const a=this.channels[e];a.pcmData=t,a.length=t.length,a.position=0,a.volume=Math.max(0,Math.min(1,i)),a.isActive=!0}stop(e){if(!this.isValidChannel(e))return;const t=this.channels[e];t.isActive=!1,t.pcmData=null,t.length=0,t.position=0}mix(e){for(let t=0;t<e.length;t++){let i=0;for(let a=0;a<Ve.MAX_CHANNELS;a++){const n=this.channels[a];if(!(!n.isActive||!n.pcmData)){if(n.position<n.length){const d=(n.pcmData[n.position]-128)/128;i+=d*n.volume,n.position++}n.position>=n.length&&this.stop(a)}}e[t]=Math.max(-1,Math.min(1,i))}}isChannelActive(e){return this.isValidChannel(e)?this.channels[e].isActive:!1}isValidChannel(e){return Number.isInteger(e)&&e>=0&&e<Ve.MAX_CHANNELS}};u(Ve,"MAX_CHANNELS",16);let Rr=Ve;class Mo{constructor(){u(this,"mixer");u(this,"opl2");u(this,"adapter");u(this,"mixBuffer");u(this,"mixCount",0);this.mixer=new Rr,this.opl2=new Ao,this.mixBuffer=new Float32Array(2048),this.adapter=new po(e=>{this.mix(e)})}async start(){try{await this.opl2.init()}catch(e){console.error("AudioEngine: OPL2 init failed",e)}try{await this.adapter.start()}catch(e){console.error("AudioEngine: Adapter start failed",e)}}stop(){this.adapter.stop()}getActiveChannelCount(){let e=0;for(let t=0;t<16;t++)this.mixer.isChannelActive(t)&&e++;return e}playSound(e,t,i){const a=this.mixer.allocate();return a<0?-1:(this.mixer.play(a,e,i),a)}stopSound(e){this.mixer.release(e)}opl2Write(e,t){this.opl2.opl2Write(e,t)}queueOpl2Write(e,t){this.opl2.opl2Write(e,t)}mix(e){if(this.mixCount++,this.mixCount%100,!this.adapter.isActive()){e.fill(0);return}this.mixer.mix(e);const t=this.opl2.generateSamples(e.length);for(let i=0;i<e.length;i++){const a=e[i],n=t[i];let l=a+n;l>1?l=1:l<-1&&(l=-1),e[i]=l}}}const Lr=(r,e)=>e.some(t=>r instanceof t);let Tn,_n;function Co(){return Tn||(Tn=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Po(){return _n||(_n=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Fr=new WeakMap,vr=new WeakMap,Kt=new WeakMap;function Ro(r){const e=new Promise((t,i)=>{const a=()=>{r.removeEventListener("success",n),r.removeEventListener("error",l)},n=()=>{t(Ge(r.result)),a()},l=()=>{i(r.error),a()};r.addEventListener("success",n),r.addEventListener("error",l)});return Kt.set(e,r),e}function Lo(r){if(Fr.has(r))return;const e=new Promise((t,i)=>{const a=()=>{r.removeEventListener("complete",n),r.removeEventListener("error",l),r.removeEventListener("abort",l)},n=()=>{t(),a()},l=()=>{i(r.error||new DOMException("AbortError","AbortError")),a()};r.addEventListener("complete",n),r.addEventListener("error",l),r.addEventListener("abort",l)});Fr.set(r,e)}let kr={get(r,e,t){if(r instanceof IDBTransaction){if(e==="done")return Fr.get(r);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return Ge(r[e])},set(r,e,t){return r[e]=t,!0},has(r,e){return r instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in r}};function $n(r){kr=r(kr)}function Fo(r){return Po().includes(r)?function(...e){return r.apply(Br(this),e),Ge(this.request)}:function(...e){return Ge(r.apply(Br(this),e))}}function ko(r){return typeof r=="function"?Fo(r):(r instanceof IDBTransaction&&Lo(r),Lr(r,Co())?new Proxy(r,kr):r)}function Ge(r){if(r instanceof IDBRequest)return Ro(r);if(vr.has(r))return vr.get(r);const e=ko(r);return e!==r&&(vr.set(r,e),Kt.set(e,r)),e}const Br=r=>Kt.get(r);function Bo(r,e,{blocked:t,upgrade:i,blocking:a,terminated:n}={}){const l=indexedDB.open(r,e),d=Ge(l);return i&&l.addEventListener("upgradeneeded",v=>{i(Ge(l.result),v.oldVersion,v.newVersion,Ge(l.transaction),v)}),t&&l.addEventListener("blocked",v=>t(v.oldVersion,v.newVersion,v)),d.then(v=>{n&&v.addEventListener("close",()=>n()),a&&v.addEventListener("versionchange",b=>a(b.oldVersion,b.newVersion,b))}).catch(()=>{}),d}const Io=["get","getKey","getAll","getAllKeys","count"],Do=["put","add","delete","clear"],br=new Map;function Sn(r,e){if(!(r instanceof IDBDatabase&&!(e in r)&&typeof e=="string"))return;if(br.get(e))return br.get(e);const t=e.replace(/FromIndex$/,""),i=e!==t,a=Do.includes(t);if(!(t in(i?IDBIndex:IDBObjectStore).prototype)||!(a||Io.includes(t)))return;const n=async function(l,...d){const v=this.transaction(l,a?"readwrite":"readonly");let b=v.store;return i&&(b=b.index(d.shift())),(await Promise.all([b[t](...d),a&&v.done]))[0]};return br.set(e,n),n}$n(r=>({...r,get:(e,t,i)=>Sn(e,t)||r.get(e,t,i),has:(e,t)=>!!Sn(e,t)||r.has(e,t)}));const Oo=["continue","continuePrimaryKey","advance"],An={},Ir=new WeakMap,xn=new WeakMap,$o={get(r,e){if(!Oo.includes(e))return r[e];let t=An[e];return t||(t=An[e]=function(...i){Ir.set(this,xn.get(this)[e](...i))}),t}};async function*xo(...r){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...r)),!e)return;e=e;const t=new Proxy(e,$o);for(xn.set(t,e),Kt.set(t,Br(e));e;)yield t,e=await(Ir.get(t)||e.continue()),Ir.delete(t)}function Mn(r,e){return e===Symbol.asyncIterator&&Lr(r,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&Lr(r,[IDBIndex,IDBObjectStore])}$n(r=>({...r,get(e,t,i){return Mn(e,t)?xo:r.get(e,t,i)},has(e,t){return Mn(e,t)||r.has(e,t)}}));const ae=class ae{async save(e,t){if(t.length>ae.MAX_SAVE_SIZE)throw new Error(`Save data exceeds limit of ${ae.MAX_SAVE_SIZE} bytes.`);try{await(await this.getDB(e)).put(ae.STORE_NAME,t,"current")}catch(i){throw console.warn(`Failed to save data for cartridge "${e}":`,i),i}}async load(e){try{const i=await(await this.getDB(e)).get(ae.STORE_NAME,"current");return i?i instanceof Uint8Array?i:i&&typeof i=="object"&&"buffer"in i&&i.byteLength!==void 0?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):null:null}catch(t){return console.warn(`Failed to load data for cartridge "${e}":`,t),null}}async getDB(e){const t=`${ae.DB_NAME_PREFIX}${e}`;return Bo(t,1,{upgrade(i){i.objectStoreNames.contains(ae.STORE_NAME)||i.createObjectStore(ae.STORE_NAME)}})}};u(ae,"DB_NAME_PREFIX","GoldenAgeCon_"),u(ae,"STORE_NAME","saveData"),u(ae,"MAX_SAVE_SIZE",64*1024);let Dr=ae;class Wo{constructor(e,t){u(this,"adapter");u(this,"cartridgeId");this.cartridgeId=e,this.adapter=t??new Dr}save(e){this.adapter.save(this.cartridgeId,e).catch(t=>{console.warn(`Failed to save cartridge data for "${this.cartridgeId}":`,t)})}load(e){return null}}class se{constructor(e){u(this,"framebuffer");u(this,"palette");u(this,"renderer");u(this,"contentWidth");u(this,"contentHeight");u(this,"letterboxMode");u(this,"letterboxColorIndex");this.framebuffer=e.framebuffer,this.palette=e.palette,this.renderer=e.renderer,this.contentWidth=se.normalizeDimension(e.contentWidth??le.WIDTH,"Content width"),this.contentHeight=se.normalizeDimension(e.contentHeight??le.HEIGHT,"Content height"),se.assertContentFits(this.contentWidth,this.contentHeight),this.letterboxMode=se.normalizeLetterboxMode(e.letterboxMode??"auto"),this.letterboxColorIndex=se.normalizePaletteIndex(e.letterboxColorIndex??0)}flip(){const e=this.framebuffer.getBytes(),t=this.palette.getRgbaBytes();this.renderer.render(e,t,{contentWidth:this.contentWidth,contentHeight:this.contentHeight,letterbox:this.resolveLetterbox(),letterboxColorIndex:this.letterboxColorIndex})}present(){this.flip()}setFramebuffer(e){this.framebuffer=e}setPalette(e){this.palette=e}setScale(e){this.renderer.setScale(e)}getScale(){return this.renderer.getScale()}setContentSize(e,t){const i=se.normalizeDimension(e,"Content width"),a=se.normalizeDimension(t,"Content height");se.assertContentFits(i,a),this.contentWidth=i,this.contentHeight=a}getContentSize(){return{width:this.contentWidth,height:this.contentHeight}}setLetterboxMode(e){this.letterboxMode=se.normalizeLetterboxMode(e)}getLetterboxMode(){return this.letterboxMode}setLetterboxColorIndex(e){this.letterboxColorIndex=se.normalizePaletteIndex(e)}getLetterboxColorIndex(){return this.letterboxColorIndex}resolveLetterbox(){switch(this.letterboxMode){case"always":return!0;case"never":return!1;case"auto":default:return this.contentWidth!==le.WIDTH||this.contentHeight!==le.HEIGHT}}static normalizeDimension(e,t){if(!Number.isInteger(e)||e<=0)throw new RangeError(`${t} must be a positive integer.`);return e}static normalizePaletteIndex(e){if(!Number.isInteger(e)||e<0||e>255)throw new RangeError("Palette index must be between 0 and 255.");return e}static normalizeLetterboxMode(e){if(e!=="auto"&&e!=="always"&&e!=="never")throw new RangeError("Letterbox mode must be auto, always, or never.");return e}static assertContentFits(e,t){if(e>le.WIDTH||t>le.HEIGHT)throw new RangeError("Content dimensions exceed framebuffer size.")}}const D=class D{constructor(e){u(this,"canvas");u(this,"context");u(this,"imageDataFactory");u(this,"scale");u(this,"imageData",null);this.canvas=e.canvas,this.context=e.context??D.resolveContext(e.canvas),this.imageDataFactory=e.imageDataFactory??D.defaultImageDataFactory(),this.scale=D.normalizeScale(e.scale??1),this.applyPixelPerfectSettings(),this.resizeCanvas()}render(e,t,i={}){const a=D.normalizeDimension(i.contentWidth??D.WIDTH,"Content width"),n=D.normalizeDimension(i.contentHeight??D.HEIGHT,"Content height");if(a>D.WIDTH||n>D.HEIGHT)throw new RangeError("Content dimensions exceed framebuffer size.");if(t.length!==D.PALETTE_BYTES)throw new RangeError(`Palette must be ${D.PALETTE_BYTES} bytes (RGBA per entry).`);const l=a*n,d=D.WIDTH*D.HEIGHT;if(e.length!==l&&e.length!==d)throw new RangeError(`Framebuffer must be ${l} or ${d} bytes, got ${e.length}.`);const v=i.letterbox??!1,b=D.normalizePaletteIndex(i.letterboxColorIndex??0),C=D.WIDTH,E=D.HEIGHT,A=v?Math.floor((C-a)/2):0,$=v?Math.floor((E-n)/2):0,K=C*this.scale,q=E*this.scale,U=this.ensureImageData(K,q),x=U.data;(v||a!==C||n!==E)&&D.fillWithPaletteIndex(x,t,b);const H=t,fe=this.scale;for(let we=0;we<n;we+=1){const $e=we*a,xe=($+we)*fe;for(let j=0;j<a;j+=1){const he=e[$e+j]*4,Y=H[he],We=H[he+1],lt=H[he+2],ft=H[he+3],qe=(A+j)*fe;for(let ee=0;ee<fe;ee+=1){const Pe=(xe+ee)*K+qe;for(let Re=0;Re<fe;Re+=1){const k=(Pe+Re)*4;x[k]=Y,x[k+1]=We,x[k+2]=lt,x[k+3]=ft}}}}this.context.putImageData(U,0,0)}setScale(e){const t=D.normalizeScale(e);t!==this.scale&&(this.scale=t,this.applyPixelPerfectSettings(),this.resizeCanvas(),this.imageData=null)}getScale(){return this.scale}ensureImageData(e,t){return this.imageData&&this.imageData.width===e&&this.imageData.height===t?this.imageData:(this.imageData=this.imageDataFactory(e,t),this.imageData)}resizeCanvas(){const e=D.WIDTH*this.scale,t=D.HEIGHT*this.scale;this.canvas.width=e,this.canvas.height=t}applyPixelPerfectSettings(){this.context.imageSmoothingEnabled=!1,this.canvas.style&&(this.canvas.style.imageRendering="pixelated")}static fillWithPaletteIndex(e,t,i){const a=i*4,n=t[a],l=t[a+1],d=t[a+2],v=t[a+3];for(let b=0;b<e.length;b+=4)e[b]=n,e[b+1]=l,e[b+2]=d,e[b+3]=v}static resolveContext(e){const t=e.getContext("2d");if(!t)throw new Error("CanvasRenderer requires a 2D canvas context.");return t}static defaultImageDataFactory(){return(e,t)=>typeof ImageData<"u"?new ImageData(e,t):{data:new Uint8ClampedArray(e*t*4),width:e,height:t}}static normalizeScale(e){if(!Number.isInteger(e)||e<=0)throw new RangeError("Scale must be a positive integer.");return e}static normalizeDimension(e,t){if(!Number.isInteger(e)||e<=0)throw new RangeError(`${t} must be a positive integer.`);return e}static normalizePaletteIndex(e){if(!Number.isInteger(e)||e<0||e>255)throw new RangeError("Palette index must be between 0 and 255.");return e}};u(D,"WIDTH",le.WIDTH),u(D,"HEIGHT",le.HEIGHT),u(D,"PALETTE_BYTES",256*4);let Or=D;class No{constructor(e={}){u(this,"target");u(this,"resolveKey");u(this,"liveKeys",new Set);u(this,"snapshotKeys",new Set);u(this,"snapshotTick",null);u(this,"handleKeyDown",e=>{this.handleKeyChange(e,!0)});u(this,"handleKeyUp",e=>{this.handleKeyChange(e,!1)});u(this,"handleBlur",()=>{this.reset()});if(!e.target&&typeof window>"u")throw new Error("KeyboardState requires an EventTarget.");this.target=e.target??window,this.resolveKey=e.resolveKey??zo,this.target.addEventListener("keydown",this.handleKeyDown),this.target.addEventListener("keyup",this.handleKeyUp),this.target.addEventListener("blur",this.handleBlur)}snapshot(e){Uo(e),this.snapshotTick!==e&&(this.snapshotTick=e,this.snapshotKeys=new Set(this.liveKeys))}isKeyDown(e){return typeof e=="string"&&Yt[e]?this.snapshotKeys.has(Yt[e]):this.snapshotKeys.has(e)}getSnapshotTick(){return this.snapshotTick}getSnapshotKeys(){return new Set(this.snapshotKeys)}reset(){this.liveKeys.clear(),this.snapshotKeys.clear(),this.snapshotTick=null}dispose(){this.target.removeEventListener("keydown",this.handleKeyDown),this.target.removeEventListener("keyup",this.handleKeyUp),this.target.removeEventListener("blur",this.handleBlur)}handleKeyChange(e,t){const i=this.resolveKey(e);if(i!==null){if(t){this.liveKeys.add(i);return}this.liveKeys.delete(i)}}}const Yt={Escape:1,Digit1:2,Digit2:3,Digit3:4,Digit4:5,Digit5:6,Digit6:7,Digit7:8,Digit8:9,Digit9:10,Digit0:11,Minus:12,Equal:13,Backspace:14,Tab:15,KeyQ:16,KeyW:17,KeyE:18,KeyR:19,KeyT:20,KeyY:21,KeyU:22,KeyI:23,KeyO:24,KeyP:25,BracketLeft:26,BracketRight:27,Enter:28,ControlLeft:29,KeyA:30,KeyS:31,KeyD:32,KeyF:33,KeyG:34,KeyH:35,KeyJ:36,KeyK:37,KeyL:38,Semicolon:39,Quote:40,Backquote:41,ShiftLeft:42,Backslash:43,KeyZ:44,KeyX:45,KeyC:46,KeyV:47,KeyB:48,KeyN:49,KeyM:50,Comma:51,Period:52,Slash:53,ShiftRight:54,NumpadMultiply:55,AltLeft:56,Space:57,CapsLock:58,F1:59,F2:60,F3:61,F4:62,F5:63,F6:64,F7:65,F8:66,F9:67,F10:68,Pause:69,ScrollLock:70,Numpad7:71,Numpad8:72,Numpad9:73,NumpadSubtract:74,Numpad4:75,Numpad5:76,Numpad6:77,NumpadAdd:78,Numpad1:79,Numpad2:80,Numpad3:81,Numpad0:82,NumpadDecimal:83,F11:87,F12:88,NumpadEnter:96,ControlRight:97,NumpadDivide:98,PrintScreen:99,AltRight:100,Home:102,ArrowUp:103,PageUp:104,ArrowLeft:105,ArrowRight:106,End:107,ArrowDown:108,PageDown:109,Insert:110,Delete:111},zo=r=>r.code&&Yt[r.code]?Yt[r.code]:r.code?r.code:r.key?r.key:Number.isInteger(r.keyCode)&&r.keyCode>0?r.keyCode:null,Uo=r=>{if(!Number.isInteger(r)||r<0)throw new RangeError("Tick must be a non-negative integer.")};class Ho{constructor(e={}){u(this,"target");u(this,"isPointerLocked");u(this,"liveDeltaX",0);u(this,"liveDeltaY",0);u(this,"snapshotDeltaX",0);u(this,"snapshotDeltaY",0);u(this,"deltaConsumed",!0);u(this,"liveButtons",new Set);u(this,"snapshotButtons",new Set);u(this,"snapshotTick",null);u(this,"handleMouseMove",e=>{const t=e;if(!this.isPointerLocked())return;const i=Number.isFinite(t.movementX)?t.movementX:0,a=Number.isFinite(t.movementY)?t.movementY:0;this.liveDeltaX+=i,this.liveDeltaY+=a});u(this,"handleMouseDown",e=>{const t=e;this.liveButtons.add(t.button)});u(this,"handleMouseUp",e=>{const t=e;this.liveButtons.delete(t.button)});u(this,"handleBlur",()=>{this.reset()});if(!e.target&&typeof window>"u")throw new Error("MouseState requires an EventTarget.");this.target=e.target??window,this.isPointerLocked=Yo(e),this.target.addEventListener("mousemove",this.handleMouseMove),this.target.addEventListener("mousedown",this.handleMouseDown),this.target.addEventListener("mouseup",this.handleMouseUp),this.target.addEventListener("blur",this.handleBlur)}snapshot(e){Vo(e),this.snapshotTick!==e&&(this.snapshotTick=e,this.snapshotButtons=new Set(this.liveButtons),this.isPointerLocked()?(this.snapshotDeltaX=this.liveDeltaX,this.snapshotDeltaY=this.liveDeltaY):(this.snapshotDeltaX=0,this.snapshotDeltaY=0),this.deltaConsumed=!1,this.liveDeltaX=0,this.liveDeltaY=0)}getMouseDelta(){if(this.snapshotTick===null||this.deltaConsumed)return{x:0,y:0};this.deltaConsumed=!0;const e={x:this.snapshotDeltaX,y:this.snapshotDeltaY};return this.snapshotDeltaX=0,this.snapshotDeltaY=0,e}isButtonDown(e){return this.snapshotButtons.has(e)}getSnapshotTick(){return this.snapshotTick}reset(){this.liveDeltaX=0,this.liveDeltaY=0,this.snapshotDeltaX=0,this.snapshotDeltaY=0,this.deltaConsumed=!0,this.liveButtons.clear(),this.snapshotButtons.clear(),this.snapshotTick=null}dispose(){this.target.removeEventListener("mousemove",this.handleMouseMove),this.target.removeEventListener("mousedown",this.handleMouseDown),this.target.removeEventListener("mouseup",this.handleMouseUp),this.target.removeEventListener("blur",this.handleBlur)}}const Yo=r=>{if(r.isPointerLocked)return r.isPointerLocked;if(r.pointerLock)return()=>{var t;return((t=r.pointerLock)==null?void 0:t.isLocked())??!1};const e=r.document??(typeof document>"u"?null:document);return e?()=>e.pointerLockElement!==null:()=>!1},Vo=r=>{if(!Number.isInteger(r)||r<0)throw new RangeError("Tick must be a non-negative integer.")};class Go{constructor(e){u(this,"target");u(this,"document");u(this,"focusTarget");u(this,"gestureTarget");u(this,"gestureEvents");u(this,"listeners",new Set);u(this,"lockedElement",null);u(this,"hasFocus",!0);u(this,"pending",!1);u(this,"lastError",null);u(this,"lastEmittedStatus",null);u(this,"disposed",!1);u(this,"handlePointerLockChange",()=>{this.lockedElement=this.document.pointerLockElement??null,this.pending=!1,this.lastError=null,this.emitStatus()});u(this,"handlePointerLockError",()=>{this.pending=!1,this.lastError="pointerlockerror",this.emitStatus()});u(this,"handleBlur",()=>{this.hasFocus&&(this.hasFocus=!1,this.pending=!1,this.lockedElement=null,this.emitStatus())});u(this,"handleFocus",()=>{this.hasFocus||(this.hasFocus=!0,this.emitStatus())});u(this,"handleGesture",()=>{this.requestLock()});var i,a;if(!e.target)throw new Error("PointerLockManager requires a target element.");const t=e.document??(typeof document>"u"?null:document);if(!t)throw new Error("PointerLockManager requires a document.");this.target=e.target,this.document=t,this.focusTarget=e.focusTarget??(typeof window>"u"?t:window),this.gestureTarget=e.gestureTarget??this.target,this.gestureEvents=e.gestureEvents??["click"],this.lockedElement=this.document.pointerLockElement??null,this.hasFocus=((a=(i=this.document).hasFocus)==null?void 0:a.call(i))??!0,this.document.addEventListener("pointerlockchange",this.handlePointerLockChange),this.document.addEventListener("pointerlockerror",this.handlePointerLockError),this.focusTarget.addEventListener("blur",this.handleBlur),this.focusTarget.addEventListener("focus",this.handleFocus);for(const n of this.gestureEvents)this.gestureTarget.addEventListener(n,this.handleGesture)}addStatusListener(e){this.listeners.add(e)}removeStatusListener(e){this.listeners.delete(e)}requestLock(){if(!(this.disposed||this.pending||this.isLocked())){if(typeof this.target.requestPointerLock!="function"){this.lastError="request_unsupported",this.emitStatus();return}this.pending=!0,this.lastError=null,this.emitStatus();try{this.target.requestPointerLock()}catch(e){this.pending=!1,this.lastError=e instanceof Error?e.message:"request_failed",this.emitStatus()}}}releaseLock(){if(!(this.disposed||!this.isLocked()&&!this.pending)){if(typeof this.document.exitPointerLock!="function"){this.pending=!1,this.lastError="exit_unsupported",this.emitStatus();return}this.document.exitPointerLock()}}isLocked(){return this.hasFocus&&this.lockedElement===this.target}getStatus(){return{locked:this.isLocked(),pending:this.pending,hasFocus:this.hasFocus,lastError:this.lastError}}dispose(){if(!this.disposed){this.disposed=!0,this.document.removeEventListener("pointerlockchange",this.handlePointerLockChange),this.document.removeEventListener("pointerlockerror",this.handlePointerLockError),this.focusTarget.removeEventListener("blur",this.handleBlur),this.focusTarget.removeEventListener("focus",this.handleFocus);for(const e of this.gestureEvents)this.gestureTarget.removeEventListener(e,this.handleGesture);this.listeners.clear()}}emitStatus(){const e=this.getStatus();if(!(this.lastEmittedStatus&&Ko(e,this.lastEmittedStatus))){this.lastEmittedStatus=e;for(const t of this.listeners)t(e)}}}const Ko=(r,e)=>r.locked===e.locked&&r.pending===e.pending&&r.hasFocus===e.hasFocus&&r.lastError===e.lastError;class qo{constructor(e={}){u(this,"keyboard");u(this,"mouse");u(this,"pointerLock");u(this,"focusTarget");u(this,"pauseOnBlur");u(this,"focusListenerOptions",{capture:!1});u(this,"snapshotTick",null);u(this,"paused",!1);u(this,"hasFocus",!0);u(this,"disposed",!1);u(this,"handleBlur",e=>{this.disposed||!this.hasFocus||e.target!==this.focusTarget&&e.target!==document||(this.hasFocus=!1,this.pauseOnBlur&&(this.paused=!0),this.keyboard.reset(),this.mouse.reset(),this.snapshotTick=null,this.pointerLock.releaseLock())});u(this,"handleFocus",e=>{this.disposed||this.hasFocus||e.target!==this.focusTarget&&e.target!==document||(this.hasFocus=!0,this.pauseOnBlur&&(this.paused=!1))});var n;const t=jo(e),i=Xo(e),a=Jo(e,t);this.pauseOnBlur=e.pauseOnBlur??!0,this.focusTarget=e.focusTarget??(typeof window>"u"?t:window),this.hasFocus=((n=i.hasFocus)==null?void 0:n.call(i))??!0,this.paused=this.pauseOnBlur?!this.hasFocus:!1,this.focusTarget.addEventListener("blur",this.handleBlur,this.focusListenerOptions),this.focusTarget.addEventListener("focus",this.handleFocus,this.focusListenerOptions),this.pointerLock=new Go({target:a,document:i,focusTarget:this.focusTarget,gestureTarget:e.gestureTarget,gestureEvents:e.gestureEvents}),this.keyboard=new No({target:t,resolveKey:e.resolveKey}),this.mouse=new Ho({target:t,pointerLock:this.pointerLock})}snapshot(e){Zo(e),this.snapshotTick!==e&&(this.snapshotTick=e,this.keyboard.snapshot(e),this.mouse.snapshot(e))}isKeyDown(e){return this.keyboard.isKeyDown(e)}is_key_down(e){return this.isKeyDown(e)}isMouseButtonDown(e){return this.mouse.isButtonDown(e)}is_mouse_button_down(e){return this.isMouseButtonDown(e)}getMouseDelta(){return this.mouse.getMouseDelta()}get_mouse_delta(){return this.getMouseDelta()}getPressedKeys(){return this.keyboard.getSnapshotKeys()}isPaused(){return this.paused}setPaused(e){this.paused=e,e||(this.hasFocus=!0)}getSnapshotTick(){return this.snapshotTick}dispose(){this.disposed||(this.disposed=!0,this.focusTarget.removeEventListener("blur",this.handleBlur,this.focusListenerOptions),this.focusTarget.removeEventListener("focus",this.handleFocus,this.focusListenerOptions),this.keyboard.dispose(),this.mouse.dispose(),this.pointerLock.dispose())}}const jo=r=>{if(r.target)return r.target;if(typeof window<"u")return window;throw new Error("InputManager requires an EventTarget.")},Xo=r=>{if(r.document)return r.document;if(typeof document<"u")return document;throw new Error("InputManager requires a document.")},Jo=(r,e)=>{if(r.pointerLockTarget)return r.pointerLockTarget;if(typeof e.requestPointerLock=="function")return e;throw new Error("InputManager requires a pointer lock target.")},Zo=r=>{if(!Number.isInteger(r)||r<0)throw new RangeError("Tick must be a non-negative integer.")},ce=class ce{constructor(e){u(this,"watchdog");u(this,"panicHandler");u(this,"memory");u(this,"maxMemoryBytes");u(this,"memoryWarningThresholds");u(this,"memoryPanicThreshold");u(this,"timeoutStrikeLimit");u(this,"onWarning");u(this,"onStop");u(this,"cleanupHooks");u(this,"strikes",0);u(this,"lastFailure",null);u(this,"running",!0);u(this,"nextMemoryWarningIndex",0);this.watchdog=e.watchdog,this.panicHandler=e.panicHandler,this.memory=e.memory,this.maxMemoryBytes=Cn(e.maxMemoryBytes??ce.DEFAULT_MAX_MEMORY_BYTES,"Max memory bytes"),this.memoryWarningThresholds=Qo(e.memoryWarningThresholds??ce.DEFAULT_WARNING_THRESHOLDS),this.memoryPanicThreshold=Wn(e.memoryPanicThreshold??ce.DEFAULT_PANIC_THRESHOLD,"Memory panic threshold"),this.timeoutStrikeLimit=Cn(e.timeoutStrikeLimit??ce.DEFAULT_STRIKE_LIMIT,"Timeout strike limit"),this.onWarning=e.onWarning,this.onStop=e.onStop,this.cleanupHooks=e.cleanupHooks??[]}runFrame(e){if(!this.running)return{ok:!1,failure:this.lastFailure,skipped:!0};this.watchdog.start();try{e()}catch(i){return this.handleRuntimeError(i),{ok:!1,failure:this.lastFailure}}const t=this.watchdog.stop();return this.handleWatchdogResult(t),this.running?(this.checkMemoryUsage(),{ok:this.running,failure:this.lastFailure,watchdog:t}):{ok:!1,failure:this.lastFailure,watchdog:t}}reportFailure(e){var t;if(!this.lastFailure){this.lastFailure=e,this.running=!1,this.panicHandler.handlePanic(e),(t=this.onStop)==null||t.call(this);for(const i of this.cleanupHooks)i()}}isRunning(){return this.running}getStrikeCount(){return this.strikes}getLastFailure(){return this.lastFailure}reset(){this.strikes=0,this.lastFailure=null,this.running=!0,this.nextMemoryWarningIndex=0}handleWatchdogResult(e){e.status==="timeout"?this.strikes+=1:this.strikes=0,e.status==="slow"&&this.emitWarning({type:"slow_frame",message:`Frame execution took ${e.elapsedMs.toFixed(2)}ms (target ${e.warnMs}ms).`,detail:{elapsedMs:e.elapsedMs,warnMs:e.warnMs,timeoutMs:e.timeoutMs}}),this.strikes>=this.timeoutStrikeLimit&&this.reportFailure({type:"timeout",message:`Frame execution exceeded ${e.timeoutMs}ms for ${this.strikes} consecutive frames.`,detail:{elapsedMs:e.elapsedMs,strikes:this.strikes,timeoutMs:e.timeoutMs}})}checkMemoryUsage(){if(!this.memory)return;const e=this.memory.buffer.byteLength,t=this.maxMemoryBytes,i=e/t;if(e>t||i>=this.memoryPanicThreshold){this.reportFailure({type:"memory_limit",message:`Memory usage at ${(i*100).toFixed(1)}% (${e} / ${t} bytes) exceeds safe limits.`,detail:{usedBytes:e,maxBytes:t,percent:i}});return}if(!(!this.onWarning||this.memoryWarningThresholds.length===0))for(;this.nextMemoryWarningIndex<this.memoryWarningThresholds.length;){const a=this.memoryWarningThresholds[this.nextMemoryWarningIndex];if(i<a)break;this.emitWarning({type:"memory_warning",message:`Memory usage at ${(i*100).toFixed(1)}% (${e} / ${t} bytes).`,detail:{usedBytes:e,maxBytes:t,percent:i,threshold:a}}),this.nextMemoryWarningIndex+=1}}emitWarning(e){var t;(t=this.onWarning)==null||t.call(this,e)}handleRuntimeError(e){const t=ce.normalizeError(e);this.reportFailure(t)}static normalizeError(e){return e instanceof Error?ce.isMemoryError(e)?{type:"memory_limit",message:`WASM memory limit exceeded: ${e.message||"Unknown memory error."}`,detail:e}:{type:"runtime_error",message:`WASM runtime error: ${e.message||"Unknown error."}`,detail:e}:{type:"runtime_error",message:"WASM runtime error: Unknown error.",detail:e}}static isMemoryError(e){return e instanceof RangeError?e.message?/memory|grow|alloc|maximum|out of memory/i.test(e.message):!0:!1}};u(ce,"DEFAULT_MAX_MEMORY_BYTES",_e.MAX_PAGES*_e.PAGE_BYTES),u(ce,"DEFAULT_WARNING_THRESHOLDS",[.75,.9]),u(ce,"DEFAULT_PANIC_THRESHOLD",.95),u(ce,"DEFAULT_STRIKE_LIMIT",3);let $r=ce;const Cn=(r,e)=>{if(!Number.isInteger(r)||r<=0)throw new RangeError(`${e} must be a positive integer.`);return r},Wn=(r,e)=>{if(typeof r!="number"||!Number.isFinite(r)||r<=0||r>1)throw new RangeError(`${e} must be between 0 and 1.`);return r},Qo=r=>{if(!Array.isArray(r)||r.length===0)return[];const e=r.map((i,a)=>Wn(i,`Memory warning threshold ${a+1}`));e.sort((i,a)=>i-a);const t=[];for(const i of e)(t.length===0||t[t.length-1]!==i)&&t.push(i);return t};class ea{constructor(e=()=>{}){u(this,"onPanic");this.onPanic=e}handlePanic(e){this.onPanic(e)}}const Be=class Be{constructor(e={}){u(this,"now");u(this,"warnMs");u(this,"timeoutMs");u(this,"startTime",null);if(this.now=e.now??(()=>typeof performance<"u"?performance.now():Date.now()),this.warnMs=Be.normalizeLimit(e.warnMs??Be.DEFAULT_WARN_MS,"Warn limit"),this.timeoutMs=Be.normalizeLimit(e.timeoutMs??Be.DEFAULT_TIMEOUT_MS,"Timeout limit"),this.timeoutMs<=this.warnMs)throw new RangeError("Timeout limit must be greater than warn limit.")}start(){this.startTime=this.now()}stop(){if(this.startTime===null)throw new Error("WatchdogTimer.stop() called before start().");const e=this.now()-this.startTime;return this.startTime=null,{status:e>this.timeoutMs?"timeout":e>this.warnMs?"slow":"ok",elapsedMs:e,warnMs:this.warnMs,timeoutMs:this.timeoutMs}}static normalizeLimit(e,t){if(typeof e!="number"||!Number.isFinite(e)||e<=0)throw new RangeError(`${t} must be a positive number.`);return e}};u(Be,"DEFAULT_WARN_MS",28),u(Be,"DEFAULT_TIMEOUT_MS",100);let xr=Be;const St=document.querySelector("#screen"),Nn=document.querySelector("#cartridge-input"),ne=document.querySelector("#btn-start"),Ie=document.querySelector("#btn-stop"),zn=document.querySelector("#status-state"),Un=document.querySelector("#status-ticks"),Hn=document.querySelector("#status-fps"),Tt=document.querySelector("#error-display"),xt=document.querySelector("#fullscreen-checkbox");if(!St||!Nn||!ne||!Ie||!zn||!Un||!Hn||!Tt||!xt)throw new Error("Missing UI elements");const ta=new WebAssembly.Memory({initial:256}),ra=new le(ta),na=new Ht,ia=new Or({canvas:St,scale:3}),Vt=new se({framebuffer:ra,palette:na,renderer:ia}),sa=new qo({target:window,pointerLockTarget:St}),oa=new Mo,aa=r=>new Wo(r),ca=new Ut,Yn=new to(ca),ua=new xr,la=new ea(r=>{console.error("Runtime Panic:",r),Oe(`Runtime Panic: ${r.message} (${r.type})`)}),fa=new $r({watchdog:ua,panicHandler:la}),ha=new Wt(12345),De=new go(Vt,sa,Yn,fa,ha,aa,oa,St);let Pn=performance.now(),Er=0,Vn=0,ct=!1;function da(){const r=performance.now();Er++,r-Pn>=1e3&&(Vn=Er,Er=0,Pn=r)}const ma=Vt.present.bind(Vt);Vt.present=()=>{ma(),da()};function Oe(r){Tt.textContent=r,Tt.classList.remove("hidden"),console.error(r)}function ut(){Tt.textContent="",Tt.classList.add("hidden")}function At(){const r=De.getState(),e=Yn.getTickCounter().getTick();zn.textContent=r.toUpperCase(),Un.textContent=e.toString(),Hn.textContent=Vn.toString(),ne.disabled=r==="running"||!ct,Ie.disabled=r!=="running"}async function Mt(){if(xt!=null&&xt.checked){const r=St.closest(".bg-black");r!=null&&r.requestFullscreen&&await r.requestFullscreen()}De.start(),At()}Nn.addEventListener("change",async r=>{var t;const e=(t=r.target.files)==null?void 0:t[0];if(e){ut(),ne.disabled=!0,Ie.disabled=!0;try{const i=await e.arrayBuffer();await De.loadCartridge(new Uint8Array(i)),ct=!0,console.log("Cartridge loaded successfully"),At(),ne.disabled=!1}catch(i){Oe(`Failed to load cartridge: ${i instanceof Error?i.message:String(i)}`)}}});const Tr=document.querySelector("#btn-debug-load");Tr==null||Tr.addEventListener("click",async()=>{ut(),ne.disabled=!0,Ie.disabled=!0;try{const r=await fetch("/pac-man.gac");if(!r.ok)throw new Error(`HTTP error ${r.status}`);const e=await r.arrayBuffer();await De.loadCartridge(new Uint8Array(e)),ct=!0,console.log("Debug Pac-Man Cartridge loaded successfully"),await Mt(),ne.disabled=!1}catch(r){Oe(`Failed to debug load Pac-Man: ${r instanceof Error?r.message:String(r)}`)}});const _r=document.querySelector("#btn-debug-load-space");_r==null||_r.addEventListener("click",async()=>{ut(),ne.disabled=!0,Ie.disabled=!0;try{const r=await fetch("/space-invaders.gac");if(!r.ok)throw new Error(`HTTP error ${r.status}`);const e=await r.arrayBuffer();await De.loadCartridge(new Uint8Array(e)),ct=!0,console.log("Debug Space Invaders Cartridge loaded successfully"),await Mt(),ne.disabled=!1}catch(r){Oe(`Failed to debug load space invaders: ${r instanceof Error?r.message:String(r)}`)}});const Sr=document.querySelector("#btn-debug-load-audio");Sr==null||Sr.addEventListener("click",async()=>{ut(),ne.disabled=!0,Ie.disabled=!0;try{const r=await fetch("/audio-test.gac");if(!r.ok)throw new Error(`HTTP error ${r.status}`);const e=await r.arrayBuffer();await De.loadCartridge(new Uint8Array(e)),ct=!0,console.log("Debug Audio Test Cartridge loaded successfully"),await Mt(),ne.disabled=!1}catch(r){Oe(`Failed to debug load audio test: ${r instanceof Error?r.message:String(r)}`)}});const Ar=document.querySelector("#btn-debug-load-doom");Ar==null||Ar.addEventListener("click",async()=>{ut(),ne.disabled=!0,Ie.disabled=!0;try{const r=await fetch("/doom.gac");if(!r.ok)throw new Error(`HTTP error ${r.status}`);const e=await r.arrayBuffer();await De.loadCartridge(new Uint8Array(e)),ct=!0,console.log("Debug Doom Cartridge loaded successfully"),await Mt(),ne.disabled=!1}catch(r){Oe(`Failed to debug load Doom: ${r instanceof Error?r.message:String(r)}`)}});ne.addEventListener("click",async()=>{try{ut(),await Mt()}catch(r){Oe(`Failed to start: ${r instanceof Error?r.message:String(r)}`)}});Ie.addEventListener("click",()=>{try{De.stop(),At()}catch(r){Oe(`Failed to stop: ${r instanceof Error?r.message:String(r)}`)}});setInterval(()=>{At()},100);At();
